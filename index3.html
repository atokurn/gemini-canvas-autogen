<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini Generative Canvas</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- JSZip untuk export ZIP -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- Lucide Icons CDN -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    <!-- Supabase JS CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Font dan Styling Kustom -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Geist:wght@600;700&display=swap');
        
        :root {
            --primary: #3b82f6;
            --primary-dark: #2563eb;
            --accent: #06b6d4;
            --success: #10b981;
            --neutral-dark: #1f2937;
            --neutral-light: #f9fafb;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            @apply bg-neutral-light text-neutral-900;
        }
        
        h1, h2 {
            font-family: 'Geist', sans-serif;
        }

        /* Custom styling untuk radio button mode tabs */
        .mode-radio:checked + label {
            @apply bg-blue-500 text-white border-blue-500;
        }
        .mode-radio { display: none; }
        
        /* Enhanced scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            @apply bg-slate-100 rounded-lg;
        }
        ::-webkit-scrollbar-thumb {
            @apply bg-slate-400 rounded-lg hover:bg-slate-500;
        }
        
        /* Improved spinner animation */
        .spinner {
            @apply border-4 border-slate-200 w-10 h-10 rounded-full;
            border-left-color: var(--primary);
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .loading-bar {
            position: relative;
            background-color: #e2e8f0;
            border-radius: 9999px;
            overflow: hidden;
        }
        .loading-bar::before {
            content: "";
            position: absolute;
            left: -40%;
            width: 40%;
            height: 100%;
            background: linear-gradient(90deg, transparent, var(--primary), transparent);
            animation: loading-slide 1.2s ease-in-out infinite;
        }
        @keyframes loading-slide {
            0% { left: -40%; }
            100% { left: 100%; }
        }
        
        /* Smooth transitions */
        button, input, select, textarea {
            @apply transition-all duration-200;
        }

        /* Command Bar contrast when overlaying bright content */
        #command-bar.cb-on-image { background-color: rgba(255,255,255,0.08); border-color: rgba(255,255,255,0.35); }
        #command-bar.cb-on-image #cb-header *,
        #command-bar.cb-on-image #cb-footer *,
        #command-bar.cb-on-image #cb-body * { color: #fff !important; }
        #command-bar.cb-on-image textarea#command-prompt { color: #fff !important; }
        #command-bar.cb-on-image textarea#command-prompt::placeholder { color: rgba(255,255,255,0.7); }
        #command-bar.cb-on-image #mode-menu, #command-bar.cb-on-image #mode-menu * { color: #e5e7eb !important; }
        .thumb-pop { position: absolute; bottom: calc(100% + 8px); left: 0; min-width: 160px; max-width: 240px; }
        .date-divider { grid-column: 1 / -1; }

        #crop-canvas {
            touch-action: none;
            -webkit-user-select: none;
            user-select: none;
        }

        
        :root { --header-height: 0px; }
        main { scroll-padding-top: var(--header-height); }
    </style>
</head>
<body class="bg-neutral-900 text-neutral-100">

    <nav id="top-nav" class="fixed top-0 inset-x-0 z-50 bg-neutral-900/80 backdrop-blur border-b border-neutral-800">
        <div class="max-w-7xl mx-auto px-4 h-12 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-md flex items-center justify-center text-white">
                    <i data-lucide="sparkles" class="w-4 h-4"></i>
                </div>
                <span class="text-sm font-semibold text-white/90">ScutiEX Studio</span>
            </div>
            <div class="flex items-center gap-2 hidden" role="menubar" aria-label="Menu Utama">
                <button class="nav-item px-3 py-1.5 rounded-md text-xs font-semibold text-neutral-200 hover:bg-white/10" data-menu="canvas" role="menuitem" aria-current="true">
                    <i data-lucide="brush" class="w-4 h-4"></i>
                    <span class="ml-1">Canvas AI</span>
                </button>
                <button class="nav-item px-3 py-1.5 rounded-md text-xs font-semibold text-neutral-200 hover:bg-white/10" data-menu="ugc" role="menuitem">
                    <i data-lucide="users" class="w-4 h-4"></i>
                    <span class="ml-1">UGC</span>
                </button>
                <button class="nav-item px-3 py-1.5 rounded-md text-xs font-semibold text-neutral-200 hover:bg-white/10" data-menu="catalog" role="menuitem">
                    <i data-lucide="shopping-bag" class="w-4 h-4"></i>
                    <span class="ml-1">Etalase</span>
                </button>
            </div>
        </div>
    </nav>

    <div class="flex flex-col lg:flex-row min-h-screen lg:h-screen lg:overflow-hidden">
        
        <!-- Enhanced Control Panel with modern styling -->
        <aside class="hidden w-full lg:w-1/3 xl:w-1/4 bg-neutral-900 h-[calc(100vh-3.5rem)] shadow-xl lg:shadow-2xl flex flex-col border-r border-neutral-800 text-neutral-200">
            <div class="flex-1 overflow-y-auto p-4 lg:p-6 space-y-6">
                
                <!-- Modern header with gradient icon -->
                <header class="mb-6 pb-4 border-b-2 border-slate-200">
                    <div class="flex items-center gap-3 mb-2">
                        <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-lg flex items-center justify-center text-white text-lg font-bold">
                            <i data-lucide="sparkles" class="w-6 h-6"></i>
                        </div>
                        <h1 id="sidebar-title" class="text-2xl font-bold bg-gradient-to-r from-blue-600 to-cyan-600 bg-clip-text text-transparent">Canvas AI</h1>
                    </div>
                    <p class="text-xs text-slate-500">Generasi gambar dengan teknologi Gemini</p>
                </header>

                <!-- (MOVED) Notification Area -->
                <div id="message-box" class="hidden p-3 rounded-lg text-sm font-medium text-center border"></div>

                <div id="sidebar-canvas">
                <!-- Mode selector with enhanced styling -->
                <section>
                    <label class="text-sm font-semibold text-neutral-200 mb-2 block">Mode Input</label>
                    <div class="flex gap-1 p-1 bg-white/5 rounded-lg border border-neutral-700">
                        <input type="radio" id="mode-single" name="mode" value="single" class="mode-radio" checked>
                        <label for="mode-single" class="flex-1 text-center py-2 px-4 cursor-pointer rounded-md font-medium text-sm transition-all duration-200 hover:bg-white/10 text-neutral-200">Single</label>
                        
                        <input type="radio" id="mode-template" name="mode" value="template" class="mode-radio">
                        <label for="mode-template" class="flex-1 text-center py-2 px-4 cursor-pointer rounded-md font-medium text-sm transition-all duration-200 hover:bg-white/10 text-neutral-200">Template</label>
                        
                        <!-- (BARU) Mode List -->
                        <input type="radio" id="mode-list" name="mode" value="list" class="mode-radio">
                        <label for="mode-list" class="flex-1 text-center py-2 px-4 cursor-pointer rounded-md font-medium text-sm transition-all duration-200 hover:bg-white/10 text-neutral-200">List</label>
                    </div>
                </section>

                <!-- Input panels with enhanced styling -->
                <section class="space-y-4">

                    
                    <!-- Template Mode -->
                    <div id="panel-template" class="hidden space-y-3">
                        <label class="text-sm font-semibold text-neutral-200 mb-2 block">Template Gaya Terpilih</label>
                        <div id="selected-templates" class="grid grid-cols-2 sm:grid-cols-3 gap-2 mb-3"></div>
                        <div class="flex justify-between items-center">
                            <span id="selected-templates-count" class="text-xs text-neutral-400">0 template dipilih</span>
                            <button id="open-template-modal" class="text-xs py-1.5 px-3 rounded-md font-semibold bg-blue-600 text-white hover:bg-blue-700">Pilih Template</button>
                        </div>
                        <div>
                            <label for="prompt-template" class="text-sm font-semibold text-neutral-200 mb-2 block">Deskripsi Gambar / Subjek (Template)</label>
                            <textarea id="prompt-template" rows="5" class="w-full p-3 border-2 border-neutral-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-transparent text-neutral-200 placeholder:text-neutral-500 text-sm resize-none" placeholder="Misalnya: Deskripsi subjek untuk menggantikan [SUBJECT] pada template"></textarea>
                        </div>
                    </div>
                    
                    <!-- (DIMODIFIKASI BESAR) Panel Mode List -->
                    <div id="panel-list" class="hidden space-y-3">
                        <!-- Bagian URL Google Sheet (Tetap) -->
                        <div class="p-3 bg-slate-50 rounded-lg border border-slate-200 space-y-2">
                            <label for="list-sheet-url" class="text-sm font-semibold text-slate-700 block">URL Google Sheet (CSV)</label>
                            <input type="text" id="list-sheet-url" class="w-full p-2 border border-slate-300 rounded-md text-xs focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white" placeholder="Tempel URL ...pub?output=csv">
                            <div class="flex gap-2 justify-between items-center mt-2">
                                <a href="https://docs.google.com/spreadsheets/d/e/2PACX-1vQLBAtKrciBdKf0A0UpkcwtgyegbOpQhrsw1Q7sSBw7Ttv1YGbpinSRJKTg0Cs3k_-Rzz6ig4UQNN_w/pub?output=csv" target="_blank" class="text-xs text-blue-600 hover:underline">
                                    Lihat Contoh
                                </a>
                                <button id="save-list-url-btn" class="text-xs py-1.5 px-3 rounded-md font-semibold bg-green-500 text-white hover:bg-green-600 transition-colors">
                                    Simpan
                                </button>
                            </div>
                        </div>

                        <!-- (MODIFIKASI) Status Batch dengan Timer -->
                        <div class="p-3 bg-slate-50 rounded-lg border border-slate-200">
                            <label class="text-sm font-semibold text-slate-700 block">Status Batch</label>
                            <p class="text-xs text-slate-500 mt-1 mb-2">Ambil daftar prompt dari Google Sheet.</p>
                            <div class="flex items-center justify-between">
                                <span class="text-xs font-medium text-slate-600">Total Prompt:</span>
                                <span id="list-total-count" class="font-bold text-blue-600">0</span>
                            </div>
                            <div class="flex items-center justify-between mt-1">
                                <span class="text-xs font-medium text-slate-600">Sedang Berjalan:</span>
                                <span id="list-current-prompt" class="font-bold text-slate-800 text-xs truncate">N/A</span>
                            </div>
                            <!-- (BARU) Timer Countdown -->
                            <div class="flex items-center justify-between mt-1">
                                <span class="text-xs font-medium text-slate-600">Prompt Berikutnya:</span>
                                <span id="list-countdown-time" class="font-bold text-cyan-600 text-xs">--</span>
                            </div>
                            <!-- (BARU) Timer Total Waktu -->
                            <div class="flex items-center justify-between mt-3 pt-3 border-t border-slate-200">
                                <span class="text-xs font-medium text-slate-600">Total Waktu Berjalan:</span>
                                <span id="list-total-time" class="font-bold text-slate-800 text-xs">00:00:00</span>
                            </div>
                            <button id="sync-list-btn" class="w-full mt-3 text-xs text-center py-1.5 px-3 rounded-md font-semibold bg-blue-500 text-white hover:bg-blue-600 transition-colors">
                                Sinkronisasi Daftar Prompt
                            </button>
                        </div>
                       

                        <!-- (BARU) Grup 2: Pengaturan System (Accordion) -->
                        <div class="space-y-3">
                            
                            <div class="border border-slate-200 rounded-lg bg-slate-50">
                                <!-- Tombol Accordion -->
                                <button id="system-accordion-btn" class="w-full flex justify-between items-center p-3 text-sm font-semibold text-slate-700">
                                    <span>Pengaturan System</span>
                                <i id="system-accordion-icon" data-lucide="chevron-down" class="w-4 h-4 transition-transform duration-200"></i>
                            </button>
                                <!-- Konten Accordion -->
                                <div id="system-accordion-content" class="hidden p-3 border-t border-slate-200 space-y-4">
                                    <!-- Pengaturan Interval (Statis/Random) -->
                                    <div>
                                        <label for="list-interval-type" class="text-xs font-medium text-slate-700 block mb-2" title="Atur jeda antar prompt: Statis (detik) atau Random (detik).">Tipe Interval</label>
                                        <select id="list-interval-type" class="w-full p-2 border border-slate-300 rounded-md text-xs focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white">
                                            <option value="static">Statis (detik)</option>
                                            <option value="random">Random (detik)</option>
                                        </select>
                                    </div>
                                    <!-- Interval Statis -->
                                    <div id="list-interval-static-container">
                                        <label for="list-interval-time" class="text-xs font-medium text-slate-700 block mb-2" title="Detik jeda antar prompt saat tipe Statis.">Interval Statis (detik)</label>
                                        <input type="number" id="list-interval-time" value="5" min="1" class="w-full p-2 border border-slate-300 rounded-md text-center text-xs focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white">
                                    </div>
                                    <!-- Interval Random -->
                                    <div id="list-interval-random-container" class="hidden flex gap-2">
                                        <div class="flex-1">
                                            <label for="list-interval-min" class="text-xs font-medium text-slate-700 block mb-2" title="Batas minimum jeda (detik) untuk tipe Random.">Min (detik)</label>
                                            <input type="number" id="list-interval-min" value="5" min="1" class="w-full p-2 border border-slate-300 rounded-md text-center text-xs focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white">
                                        </div>
                                        <div class="flex-1">
                                            <label for="list-interval-max" class="text-xs font-medium text-slate-700 block mb-2" title="Batas maksimum jeda (detik) untuk tipe Random.">Max (detik)</label>
                                            <input type="number" id="list-interval-max" value="30" min="1" class="w-full p-2 border border-slate-300 rounded-md text-center text-xs focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white">
                                        </div>
                                    </div>
                                    
                                    <!-- Unduh Otomatis -->
                                    <div class="pt-2 border-t border-slate-200">
                                        <div class="flex items-center justify-between">
                                            <label for="list-auto-download" class="text-sm font-semibold text-slate-700" title="Otomatis mengunduh setiap gambar setelah selesai dibuat.">Unduh Otomatis</label>
                                            <input type="checkbox" id="list-auto-download" class="form-checkbox h-5 w-5 text-blue-600 rounded-md border-slate-300 focus:ring-blue-500">
                                        </div>
                                    </div>
                                    
                                    <!-- (BARU) Pengulangan -->
                                    <div class="pt-2 border-t border-slate-200">
                                        <div class="flex items-center justify-between">
                                            <label for="list-repeat" class="text-sm font-semibold text-slate-700" title="Mengulangi daftar prompt dari awal setelah selesai.">Ulangi Batch</label>
                                            <input type="checkbox" id="list-repeat" class="form-checkbox h-5 w-5 text-blue-600 rounded-md border-slate-300 focus:ring-blue-500">
                                        </div>
                                        <div class="mt-2 flex items-center gap-2">
                                            <label for="list-repeat-count" class="text-xs font-medium text-slate-700" title="Jumlah pengulangan batch; 0 = tanpa batas.">Jumlah Pengulangan</label>
                                            <input type="number" id="list-repeat-count" value="0" min="0" class="w-24 p-1.5 border border-slate-300 rounded-md text-center text-xs focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white" title="0 = tanpa batas (unlimited). Jika > 0, batch mengulang sesuai jumlah." />
                                        </div>
                                    </div>

                                    <!-- (BARU) Sinkronisasi Otomatis -->
                                    <div id="list-auto-sync-container" class="pt-2 border-t border-slate-200">
                                        <div class="flex items-center justify-between">
                                            <label for="list-auto-sync" class="text-sm font-semibold text-slate-700" title="Saat batch diulang, muat ulang data dari Gâ€‘Sheet.">Sinkronisasi Otomatis</label>
                                            <input type="checkbox" id="list-auto-sync" class="form-checkbox h-5 w-5 text-blue-600 rounded-md border-slate-300 focus:ring-blue-500">
                                        </div>
                                    </div>
                                    
                                    <!-- (BARU) Nonaktifkan Riwayat untuk Mode List -->
                                    <div class="pt-2 border-t border-slate-200">
                                        <div class="flex items-center justify-between">
                                            <label for="list-disable-history" class="text-sm font-semibold text-slate-700" title="Jika aktif, hasil Mode List tidak disimpan ke riwayat.">Nonaktifkan Riwayat (Mode List)</label>
                                            <input type="checkbox" id="list-disable-history" class="form-checkbox h-5 w-5 text-blue-600 rounded-md border-slate-300 focus:ring-blue-500">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Enhanced options section -->
                <section class="space-y-3">
                    <h2 class="text-sm font-semibold text-slate-700">Pengaturan</h2>
                    
                    <div id="optimizer-container" class="p-3 bg-gradient-to-r from-blue-50 to-cyan-50 rounded-lg border border-blue-200">
                        <label for="select-optimizer" class="text-xs font-medium text-slate-700 block mb-2">Optimasi Prompt</label>
                        <select id="select-optimizer" class="w-full p-2 border border-slate-300 rounded-md text-xs focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white">
                            <option value="off">Tidak (Gunakan Asli)</option>
                            <option value="image">Ya (Per Gambar)</option>
                        </select>
                    </div>
                    
                    <div class="hidden"></div>

                    <!-- Subject Reference with modern styling -->
                    <div id="subject-reference-container" class="p-3 bg-white/5 rounded-lg border-2 border-dashed border-neutral-700 hover:border-blue-400 transition-colors">
                        <div class="flex items-center gap-1 mb-2">
                            <label for="upload-subject" class="text-xs font-semibold text-neutral-200">Referensi Subjek</label>
                            <button type="button" class="relative p-0.5 text-slate-500 hover:text-blue-600" aria-label="Informasi Referensi Subjek">
                                <i data-lucide="info" class="w-3 h-3"></i>
                                <span class="pointer-events-none absolute left-1/2 -translate-x-1/2 top-full mt-1 text-[11px] bg-black text-white rounded px-2 py-1 whitespace-nowrap opacity-0 transition-opacity duration-150">Gunakan untuk mempertahankan bentuk objek utama</span>
                            </button>
                        </div>
                        <input type="file" id="upload-subject" accept="image/*" multiple class="block w-full text-xs text-slate-500 file:mr-3 file:py-2 file:px-3 file:rounded-md file:border-0 file:text-xs file:font-semibold file:bg-blue-500 file:text-white hover:file:bg-blue-600 cursor-pointer">
                        <div id="subject-preview-container" class="hidden mt-2 flex flex-wrap gap-2"></div>
                        <button id="clear-subject" class="hidden mt-2 w-full text-center font-medium"></button>
                        
                    </div>

                    <!-- (DIKEMBALIKAN) Container Referensi Gaya -->
                    <div id="style-reference-container" class="p-3 bg-white/5 rounded-lg border-2 border-dashed border-neutral-700 hover:border-cyan-400 transition-colors">
                        <div class="flex items-center gap-1 mb-2">
                            <label for="upload-style" class="text-xs font-semibold text-slate-700">Referensi Gaya</label>
                            <button type="button" class="relative p-0.5 text-slate-500 hover:text-cyan-600" aria-label="Informasi Referensi Gaya">
                                <i data-lucide="info" class="w-3 h-3"></i>
                                <span class="pointer-events-none absolute left-1/2 -translate-x-1/2 top-full mt-1 text-[11px] bg-slate-800 text-white rounded px-2 py-1 whitespace-nowrap opacity-0 transition-opacity duration-150">Gunakan untuk tone, warna, dan tekstur</span>
                            </button>
                        </div>
                        <input type="file" id="upload-style" accept="image/*" multiple class="block w-full text-xs text-slate-500 file:mr-3 file:py-2 file:px-3 file:rounded-md file:border-0 file:text-xs file:font-semibold file:bg-cyan-500 file:text-white hover:file:bg-cyan-600 cursor-pointer">
                        <div id="style-preview-container" class="hidden mt-2 flex flex-wrap gap-2"></div>
                        <button id="clear-style" class="hidden text-xs text-red-500 hover:text-red-700 mt-2 w-full text-center font-medium">Hapus</button>
                        
                    </div>
                    
                </section>
            </div>

            <!-- Enhanced action buttons section (sticky bottom for Canvas AI) -->
            <section id="sidebar-canvas-actions" class="pt-3 lg:pt-4 pb-4 border-t border-neutral-800 space-y-3 bg-neutral-900" style="position: sticky; bottom: 0; z-index: 20;">
             <!-- (MOVED) Single Prompt Mode -->
                <div id="panel-single">
                    <label for="prompt-single" class="text-sm font-semibold text-neutral-200 mb-2 block">Deskripsi Gambar / Subjek</label>
                    <textarea id="prompt-single" rows="5" class="w-full p-3 border-2 border-neutral-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-transparent text-neutral-200 placeholder:text-neutral-500 text-sm resize-none" placeholder="Misalnya: Kucing berwarna emas sedang bermain di taman cyberpunk dengan cahaya neon biru dan merah..."></textarea>
                </div>
                <button id="generate-btn" class="w-full bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-semibold py-3 px-4 rounded-lg transition-all duration-200 shadow-lg hover:shadow-xl flex items-center justify-center gap-2 active:scale-95">
                    <i id="generate-icon" data-lucide="sparkles" class="w-5 h-5"></i>
                    <span id="generate-btn-text">Hasilkan Gambar</span>
                </button>
                <!-- (MOVED) Message box was here -->
            </section>
            </div>

        </aside>

        <!-- Enhanced Canvas Output with modern styling -->
            <main class="w-full px-4 lg:px-8 pb-4 min-h-screen lg:h-screen lg:overflow-y-auto">
            <header class="sticky top-12 z-40 bg-neutral-900 flex items-center justify-between border-b border-neutral-800 py-2 px-4 lg:px-0">
                <div class="flex items-center gap-3">
                    <h2 id="canvas-view-title" class="text-lg font-semibold text-white/90">Hasil</h2>
                    <div id="header-view-toggle" class="ml-3 hidden md:flex items-center gap-1 rounded-full bg-white/5 border border-neutral-700 p-1">
                        <button data-view="canvas" class="px-3 py-1.5 text-xs font-semibold rounded-full bg-white/10 text-white">Canvas AI</button>
                        <button data-view="ugc" class="px-3 py-1.5 text-xs font-semibold rounded-full text-neutral-300 hover:bg-white/10">UGC</button>
                        <button data-view="catalog" class="px-3 py-1.5 text-xs font-semibold rounded-full text-neutral-300 hover:bg-white/10">Etalase</button>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <div class="relative w-64">
                        <i data-lucide="search" class="w-4 h-4 text-neutral-400 absolute left-2 top-1/2 -translate-y-1/2"></i>
                        <input id="output-search" type="text" placeholder="Telusuri klip" class="w-full pl-8 pr-3 py-2 rounded-md bg-white/5 border border-neutral-700 text-xs text-neutral-200 placeholder:text-neutral-500 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <button id="grid-toggle-btn" class="p-2 rounded-md bg-white/5 border border-neutral-700 text-neutral-300" title="Grid">
                        <i data-lucide="layout-grid" class="w-4 h-4"></i>
                    </button>
                    <button id="list-toggle-btn" class="p-2 rounded-md bg-white/5 border border-neutral-700 text-neutral-300" title="List">
                        <i data-lucide="list" class="w-4 h-4"></i>
                    </button>
                    <button id="download-btn" class="hidden p-2 rounded-md bg-emerald-600 text-white">
                        <i data-lucide="download" class="w-4 h-4"></i>
                    </button>
                    <button id="clear-history-btn" class="hidden p-2 rounded-md bg-rose-600 text-white" title="Hapus semua riwayat">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                </div>
            </header>

            <!-- Enhanced grid layout with modern card styling -->
            <div id="output-grid" class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-6 mt-4"></div>
            
            <div id="history-container" class="hidden space-y-4 mt-4"></div>
        </main>
    </div>

            <div id="command-bar" class="fixed bottom-6 left-1/2 -translate-x-1/2 w-[95%] sm:w-[920px] bg-white/5 border border-neutral-700 rounded-2xl shadow-xl backdrop-blur p-4 flex flex-col gap-3 z-40">
        <div id="cb-header" class="flex items-center justify-between">
            <div class="relative">
                <button id="mode-selector" class="px-3 py-1.5 rounded-md bg-white/10 hover:bg-white/15 transition-all duration-300 ease-out text-xs font-semibold text-neutral-200 flex items-center gap-1 ring-1 ring-white/10">
                    <span>Buat Gambar</span>
                    <i data-lucide="chevron-down" class="w-3 h-3"></i>
                </button>
                <div id="mode-menu" class="hidden absolute left-0 bottom-full mb-3 w-[320px] bg-neutral-900 border border-neutral-700 rounded-xl p-3 shadow-2xl space-y-2 z-50">
                    <div class="px-2 text-[11px] uppercase tracking-wide text-neutral-500">Buat Gambar</div>
                    <button data-mode="single" class="w-full text-left px-3 py-2 text-xs rounded-lg bg-white/5 hover:bg-white/10 border border-neutral-700 flex items-center gap-2"><i data-lucide="edit-3" class="w-3 h-3"></i><span>Single</span></button>
                    <button data-mode="template" class="w-full text-left px-3 py-2 text-xs rounded-lg bg-white/5 hover:bg-white/10 border border-neutral-700 flex items-center gap-2"><i data-lucide="layout-template" class="w-3 h-3"></i><span>Template</span></button>
                    <button data-mode="list" class="w-full text-left px-3 py-2 text-xs rounded-lg bg-white/5 hover:bg-white/10 border border-neutral-700 flex items-center gap-2"><i data-lucide="list" class="w-3 h-3"></i><span>List</span></button>
                    <div class="my-2 h-px bg-neutral-800"></div>
                    <div class="px-2 text-[11px] uppercase tracking-wide text-neutral-500">Video</div>
                    <button data-mode="video-text" class="w-full text-left px-3 py-2 text-xs rounded-lg bg-white/5 border border-neutral-700 flex items-center gap-2 opacity-50 cursor-not-allowed"><i data-lucide="file-text" class="w-3 h-3"></i><span>Teks ke Video</span></button>
                    <button data-mode="video-frame" class="w-full text-left px-3 py-2 text-xs rounded-lg bg-white/5 border border-neutral-700 flex items-center gap-2 opacity-50 cursor-not-allowed"><i data-lucide="film" class="w-3 h-3"></i><span>Frame menjadi Video</span></button>
                    <button data-mode="video-mix" class="w-full text-left px-3 py-2 text-xs rounded-lg bg-white/5 border border-neutral-700 flex items-center gap-2 opacity-50 cursor-not-allowed"><i data-lucide="layers" class="w-3 h-3"></i><span>Bahan menjadi Video</span></button>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <div id="settings-summary" class="hidden sm:flex items-center gap-2 px-3 py-1.5 rounded-md bg-white/10 border border-neutral-700 text-xs text-neutral-200"></div>
                <button id="open-settings-btn" class="w-9 h-9 rounded-full bg-white/10 hover:bg-white/15 transition-all duration-300 ease-out border border-neutral-700 text-neutral-200 flex items-center justify-center" title="Pengaturan">
                    <i data-lucide="sliders" class="w-4 h-4"></i>
                </button>
            </div>
        </div>
        <div id="cb-body" class="px-1 space-y-2">
            <div id="cb-textarea-body" class="rounded-xl border border-neutral-700 bg-white/5 p-1">
                <textarea id="command-prompt" rows="1" class="w-full px-3 py-2 rounded-lg bg-transparent border border-neutral-700 text-sm text-neutral-200 placeholder:text-neutral-500 focus:ring-2 focus:ring-blue-500 resize-none min-h-[36px] max-h-[160px]" placeholder="Buat gambar dari teks dan referensi"></textarea>
            </div>
            <div id="cb-template-body" class="hidden flex items-center gap-2">
                <button id="choose-template-btn" class="px-3 py-1.5 rounded-md bg-white/10 hover:bg-white/15 transition-all duration-300 ease-out text-xs font-semibold text-neutral-200 ring-1 ring-white/10">Pilih Template</button>
                <div id="template-chips" class="flex items-center gap-2 flex-wrap"></div>
            </div>
            <div id="cb-running-body" class="hidden rounded-xl border border-neutral-700 bg-white/5 p-2">
                <div class="text-[11px] text-neutral-400 mb-1">Sedang menjalankan</div>
                <div id="running-prompt-text" class="text-xs font-medium text-neutral-200 truncate"></div>
            </div>
        </div>
        <div id="cb-footer" class="flex items-center justify-between">
            <div class="relative flex items-center gap-2">
                <button id="add-ref-btn" title="Tambah referensi subjek" class="w-9 h-9 rounded-full bg-white/10 border border-neutral-700 text-neutral-200 flex items-center justify-center hover:bg-white/15 transition-all duration-300 ease-out">
                    <i data-lucide="plus" class="w-4 h-4"></i>
                </button>
                <button id="add-style-btn" title="Tambah referensi style" class="w-9 h-9 rounded-full bg-white/10 border border-neutral-700 text-neutral-200 flex items-center justify-center hover:bg-white/15 transition-all duration-300 ease-out" title="Tambah referensi gaya">
                    <i data-lucide="image" class="w-4 h-4"></i>
                </button>
                <div id="style-thumbs" class="hidden sm:flex items-center gap-1 ml-1"></div>
                <div id="ref-thumbs" class="flex items-center gap-1"></div>
                <div id="cb-stats" class="hidden sm:flex items-center gap-2 ml-2 text-xs text-neutral-400">
                    <span id="command-list-count-info"></span>
                    <span id="command-list-countdown-info" class="hidden"></span>
                    <span id="command-list-elapsed-info" class="hidden"></span>
                </div>
            </div>
            <button id="command-generate-btn" class="w-10 h-10 rounded-full bg-blue-600 hover:bg-blue-700 transition-all duration-300 ease-out text-white flex items-center justify-center shadow-lg" title="Generate">
                <i data-lucide="arrow-right" class="w-5 h-5"></i>
            </button>
        </div>
        
        <div id="upload-subject-popover" class="hidden absolute bottom-full left-4 mb-3 w-[720px] bg-neutral-900 border border-neutral-700 rounded-xl p-4 shadow-2xl z-50">
            <div class="text-xs font-semibold text-neutral-300 mb-3">Referensi Subjek</div>
            <div class="flex items-start gap-4">
                <div class="w-36 h-32 rounded-xl border-2 border-dashed border-neutral-700 p-3 flex flex-col items-center justify-center gap-2">
                    <i data-lucide="upload" class="w-5 h-5 text-neutral-400"></i>
                    <button id="upload-subject-choose-btn" class="px-3 py-2 rounded-md bg-white/10 hover:bg-white/15 text-xs border border-neutral-700">Upload</button>
                </div>
                <div id="command-subject-popover-preview" class="flex items-center gap-2 flex-wrap"></div>
            </div>
        </div>
            <div id="settings-popover" class="hidden absolute bottom-full right-0 mb-3 w-[640px] bg-neutral-900 border border-neutral-700 rounded-xl p-3 shadow-2xl z-50">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                    <div class="p-3 rounded-xl border border-neutral-700 bg-white/5">
                        <div class="text-xs font-medium text-neutral-300 mb-2">Rasio Aspek</div>
                        <div id="aspect-presets" class="flex flex-wrap gap-2">
                            <button data-aspect="16:9" class="px-3 py-1.5 text-xs rounded-md bg-white/10 hover:bg-white/15 border border-neutral-700">Lanskap (16:9)</button>
                        <button data-aspect="9:16" class="px-3 py-1.5 text-xs rounded-md bg-white/10 hover:bg-white/15 border border-neutral-700">Potret (9:16)</button>
                        <button data-aspect="1:1" class="px-3 py-1.5 text-xs rounded-md bg-white/10 hover:bg-white/15 border border-neutral-700">Square (1:1)</button>
                        <button data-aspect="3:4" class="px-3 py-1.5 text-xs rounded-md bg-white/10 hover:bg-white/15 border border-neutral-700">3:4</button>
                        <button data-aspect="4:3" class="px-3 py-1.5 text-xs rounded-md bg-white/10 hover:bg-white/15 border border-neutral-700">4:3</button>
                    </div>
                    <div class="mt-2">
                        <select id="select-aspect-ratio" class="w-full p-2 border border-neutral-700 rounded-md text-xs bg-transparent text-neutral-200">
                            <option value="1:1">1:1</option>
                            <option value="16:9">16:9</option>
                            <option value="9:16">9:16</option>
                            <option value="4:3">4:3</option>
                            <option value="3:4">3:4</option>
                        </select>
                    </div>
                </div>
                <div class="p-3 rounded-xl border border-neutral-700 bg-white/5 space-y-3">
                    <div>
                        <div class="text-xs font-medium text-neutral-300 mb-2">Output per perintah</div>
                        <input type="number" id="image-count" value="1" min="1" max="10" class="w-full p-2 border border-neutral-700 rounded-md text-center text-xs bg-transparent text-neutral-200">
                        <div class="text-[11px] text-neutral-500 mt-1">Maks 10 untuk stabilitas</div>
                    </div>
                    <div>
                        <div class="text-xs font-medium text-neutral-300 mb-2">Model</div>
                        <select id="select-model" class="w-full p-2 border border-neutral-700 rounded-md text-xs bg-transparent text-neutral-200">
                            <option value="auto">Auto</option>
                            <option value="imagen">Imagen 4.0</option>
                            <option value="gemini">Gemini Image</option>
                        </select>
                        <div class="text-[11px] text-neutral-500 mt-1">Auto memilih Gemini jika ada referensi, kalau tidak Imagen.</div>
                    </div>
                </div>
                <div id="settings-system" class="mt-3 p-3 rounded-xl border border-neutral-700 bg-white/5">
                    <button id="settings-system-accordion-btn" class="w-full flex justify-between items-center text-xs font-semibold text-neutral-300">
                        <span>Pengaturan system</span>
                        <i data-lucide="chevron-down" class="w-3 h-3" id="settings-system-accordion-icon"></i>
                    </button>
                    <div id="settings-system-content" class="hidden mt-3 space-y-3">
                        <div>
                            <div class="text-xs font-medium text-neutral-300 mb-2">Tipe Interval</div>
                            <select id="settings-list-interval-type" class="w-full p-2 border border-neutral-700 rounded-md text-xs bg-transparent text-neutral-200">
                                <option value="static">Statis (detik)</option>
                                <option value="random">Random (detik)</option>
                            </select>
                        </div>
                        <div id="settings-interval-static">
                            <div class="text-xs font-medium text-neutral-300 mb-2">Interval Statis (detik)</div>
                            <input type="number" id="settings-list-interval-time" value="5" min="1" class="w-full p-2 border border-neutral-700 rounded-md text-center text-xs bg-transparent text-neutral-200">
                        </div>
                        <div id="settings-interval-random" class="hidden grid grid-cols-2 gap-2">
                            <div>
                                <div class="text-xs font-medium text-neutral-300 mb-2">Min (detik)</div>
                                <input type="number" id="settings-list-interval-min" value="5" min="1" class="w-full p-2 border border-neutral-700 rounded-md text-center text-xs bg-transparent text-neutral-200">
                            </div>
                            <div>
                                <div class="text-xs font-medium text-neutral-300 mb-2">Max (detik)</div>
                                <input type="number" id="settings-list-interval-max" value="30" min="1" class="w-full p-2 border border-neutral-700 rounded-md text-center text-xs bg-transparent text-neutral-200">
                            </div>
                        </div>
                        <div class="pt-2 border-t border-neutral-800">
                            <div class="flex items-center justify-between">
                                <div class="text-xs font-semibold text-neutral-300">Unduh Otomatis</div>
                                <input type="checkbox" id="settings-list-auto-download" class="h-4 w-4 rounded border-neutral-700">
                            </div>
                        </div>
                        <div class="pt-2 border-t border-neutral-800">
                            <div class="flex items-center justify-between">
                                <div class="text-xs font-semibold text-neutral-300">Ulangi Batch</div>
                                <input type="checkbox" id="settings-list-repeat" class="h-4 w-4 rounded border-neutral-700">
                            </div>
                            <div class="mt-2">
                                <div class="text-[11px] text-neutral-500 mb-1">Jumlah Pengulangan (0 = tanpa batas)</div>
                                <input type="number" id="settings-list-repeat-count" value="0" min="0" class="w-24 p-1.5 border border-neutral-700 rounded-md text-center text-xs bg-transparent text-neutral-200">
                            </div>
                        </div>
                        <div class="pt-2 border-t border-neutral-800">
                            <div class="flex items-center justify-between">
                                <div class="text-xs font-semibold text-neutral-300">Sinkronisasi Otomatis</div>
                                <input type="checkbox" id="settings-list-auto-sync" class="h-4 w-4 rounded border-neutral-700">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    

    <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2 pointer-events-none"></div>

    <!-- Enhanced preview modal with download and close buttons -->
    <div id="preview-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-50 hidden">
        <div class="relative bg-white rounded-xl shadow-2xl max-w-4xl max-h-[90vh] overflow-hidden">
            <!-- Button container with both download and close buttons positioned at top -->
            <div class="absolute top-4 right-4 flex gap-2 z-10">
                <!-- Download Button (New) -->
                <button id="download-preview-btn" class="p-2 rounded-full bg-black/50 hover:bg-green-600 text-white hover:shadow-lg transition-all duration-200 active:scale-95" title="Download Image">
                    <i data-lucide="download" class="w-6 h-6"></i>
                </button>
                <button id="edit-preview-btn" class="p-2 rounded-full bg-black/50 hover:bg-blue-600 text-white hover:shadow-lg transition-all duration-200 active:scale-95" title="Edit Gambar">
                    <i data-lucide="wand-2" class="w-6 h-6"></i>
                </button>
                <!-- Close Button (Improved) -->
                <button id="close-modal-btn" class="p-2 rounded-full bg-black/50 hover:bg-red-600 text-white hover:shadow-lg transition-all duration-200 active:scale-95" title="Close Preview">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <!-- Carousel controls -->
            <button id="preview-prev-btn" class="absolute left-3 top-1/2 -translate-y-1/2 p-2 rounded-full bg-black/50 hover:bg-black/70 text-white z-10">
                <i data-lucide="chevron-left" class="w-6 h-6"></i>
            </button>
            <button id="preview-next-btn" class="absolute right-3 top-1/2 -translate-y-1/2 p-2 rounded-full bg-black/50 hover:bg-black/70 text-white z-10">
                <i data-lucide="chevron-right" class="w-6 h-6"></i>
            </button>
            <img id="modal-image" src="/placeholder.svg" alt="Pratinjau" class="w-full h-auto object-contain max-h-[85vh] rounded-lg">
            <div id="preview-counter" class="absolute left-1/2 -translate-x-1/2 px-2 py-1 rounded bg-black/50 text-white text-xs z-10" style="bottom:12px">1 / 1</div>
            <div id="edit-panel" class="absolute bottom-0 left-0 right-0 bg-black/60 p-3 flex items-center gap-2 hidden">
                <input id="edit-prompt-input" type="text" class="flex-1 px-3 py-2 rounded-md bg-white/90 text-slate-800 text-xs placeholder-slate-500" placeholder="Instruksi edit (contoh: tambahkan kacamata, hapus objek)">
                <button id="apply-edit-btn" class="px-3 py-2 rounded-md bg-blue-600 hover:bg-blue-700 text-white text-xs font-semibold">Terapkan</button>
                <button id="cancel-edit-btn" class="px-3 py-2 rounded-md bg-slate-200 hover:bg-slate-300 text-slate-800 text-xs font-semibold">Batal</button>
            </div>
            <div id="edit-loading" class="absolute inset-0 bg-black/40 flex items-center justify-center gap-3 hidden">
                <div class="spinner"></div>
                <span class="text-white text-sm">Mengedit gambar...</span>
            </div>
        </div>
    </div>

    <!-- (BARU) Modal Crop Referensi Subjek -->
    <div id="crop-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-5xl overflow-hidden flex flex-col max-h-[90vh]">
            <!-- Header -->
            <div class="px-4 py-3 border-b border-slate-200 flex flex-col md:flex-row md:items-center md:justify-between gap-2">
                <h3 class="text-sm font-semibold text-slate-800">Edit Crop Referensi Subjek</h3>
                <div class="flex items-center gap-2 w-full md:w-auto">
                    <span class="text-xs font-medium text-slate-700 flex-shrink-0">Aspek Rasio:</span>
                    <div id="crop-aspect-buttons" class="flex items-center gap-1 overflow-x-auto overscroll-contain whitespace-nowrap -mx-1 px-1">
                        <button type="button" data-aspect="free" class="px-2 py-1 rounded-full text-xs font-semibold bg-blue-600 text-white">Free</button>
                        <button type="button" data-aspect="1:1" class="px-2 py-1 rounded-full text-xs font-semibold bg-slate-100 text-slate-700 border border-slate-300">1:1</button>
                        <button type="button" data-aspect="4:3" class="px-2 py-1 rounded-full text-xs font-semibold bg-slate-100 text-slate-700 border border-slate-300">4:3</button>
                        <button type="button" data-aspect="3:4" class="px-2 py-1 rounded-full text-xs font-semibold bg-slate-100 text-slate-700 border border-slate-300">3:4</button>
                        <button type="button" data-aspect="16:9" class="px-2 py-1 rounded-full text-xs font-semibold bg-slate-100 text-slate-700 border border-slate-300">16:9</button>
                        <button type="button" data-aspect="9:16" class="px-2 py-1 rounded-full text-xs font-semibold bg-slate-100 text-slate-700 border border-slate-300">9:16</button>
                    </div>
                    <select id="crop-aspect" class="hidden">
                        <option value="free" selected>Bebas</option>
                        <option value="1:1">1:1</option>
                        <option value="4:3">4:3</option>
                        <option value="3:4">3:4</option>
                        <option value="16:9">16:9</option>
                        <option value="9:16">9:16</option>
                        <option value="3:2">3:2</option>
                        <option value="2:3">2:3</option>
                    </select>
                </div>
            </div>
            <!-- Body (scrollable) -->
            <div class="px-4 py-4">
                <div class="grid grid-cols-1 md:grid-cols-[minmax(0,1fr)_16rem] gap-4">
                    <!-- Body kiri: kanvas gambar (scroll independen) -->
                    <div class="min-w-0">
                        <div id="crop-left-scroll" class="relative border border-slate-200 rounded-md overflow-auto overscroll-contain bg-slate-50 max-h-[60vh] md:max-h-[70vh]">
                            <canvas id="crop-canvas" class="w-full h-auto block"></canvas>
                        </div>
                    </div>
                    <!-- Body kanan: preview (scroll independen) -->
                    <div class="hidden md:block">
                        <div id="crop-right-scroll" class="overflow-auto overscroll-contain max-h-[60vh] md:max-h-[70vh]">
                            <p class="text-xs font-medium text-slate-700 mb-1">Preview</p>
                            <div class="border border-slate-200 rounded-md overflow-hidden bg-slate-50">
                                <canvas id="crop-preview" class="w-full h-auto block"></canvas>
                            </div>
                            <div class="mt-3 flex items-center gap-2">
                                <button id="crop-undo" class="px-2 py-1 text-xs rounded-md border border-slate-300 text-slate-700 hover:bg-slate-100">Undo</button>
                                <button id="crop-redo" class="px-2 py-1 text-xs rounded-md border border-slate-300 text-slate-700 hover:bg-slate-100">Redo</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Footer -->
            <div class="px-4 py-3 border-t border-slate-200 flex items-center justify-between gap-3">
                <p id="crop-info" class="text-[11px] text-slate-600">Ukuran: â€” Ã— â€” px â€¢ Rasio: Bebas</p>
                <div class="flex justify-end gap-2">
                    <button id="crop-cancel" class="px-3 py-1.5 text-sm rounded-md border border-slate-300 text-slate-700 hover:bg-slate-100">Batal</button>
                    <button id="crop-apply" class="px-3 py-1.5 text-sm rounded-md bg-blue-600 text-white hover:bg-blue-700">Simpan Crop</button>
                </div>
            </div>
        </div>
    </div>

    <!-- (BARU) Modal Pemilihan Template Gaya -->
    <div id="template-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-6xl overflow-hidden flex flex-col">
            <!-- Header -->
            <div class="flex items-center justify-between px-4 py-3 border-b border-slate-200">
                <div class="flex items-center gap-2 w-full">
                    <button id="close-template-modal" class="p-2 rounded-md bg-slate-100 hover:bg-slate-200" title="Tutup">
                        <i data-lucide="x" class="w-4 h-4"></i>
                    </button>
                    <button id="template-view-toggle" class="p-2 rounded-md bg-slate-100 hover:bg-slate-200" title="Ubah tampilan Grid/List">
                        <i data-lucide="layout-grid" class="w-4 h-4"></i>
                    </button>
                    <div class="flex-1 relative">
                        <i data-lucide="search" class="w-4 h-4 text-slate-500 absolute left-2 top-1/2 -translate-y-1/2"></i>
                        <input id="template-search" type="text" class="w-full pl-8 p-2 border border-slate-300 rounded-md text-xs focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white" placeholder="Cari nama, deskripsi, kategori, atau isi prompt...">
                    </div>
                    <select id="template-category-filter" class="p-2 border border-slate-300 rounded-md text-xs bg-white">
                        <option value="">Semua Kategori</option>
                    </select>
                    <button id="template-search-clear" class="text-xs py-1.5 px-3 rounded-md font-semibold bg-slate-100 hover:bg-slate-200 text-slate-700 border border-slate-300">Reset</button>
                    <button id="sync-templates-btn" class="p-1.5 rounded-md bg-blue-50 hover:bg-blue-100 text-blue-600 transition-colors" title="Sinkronisasi Template">
                        <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>
            <!-- Body: ukuran tetap dengan scroll vertikal otomatis -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 h-[550px] overflow-hidden px-2">
                <!-- Kiri: daftar scrollable -->
                <div class="lg:col-span-2 p-4 lg:border-r border-slate-200 h-full min-h-0">
                    <!-- Ukuran fixed: width 500px (pada layar besar) dan height 400px, scroll vertikal otomatis -->
                    <div id="template-left-scroll" class="w-full lg:w-[500px] h-full overflow-y-auto overscroll-contain scroll-smooth p-2 pb-4 box-border">
                        <div id="template-buttons" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4"></div>
                    </div>
                </div>
                <!-- Kanan: preview besar (disembunyikan di mobile) -->
                <div class="p-4 h-full min-h-0 hidden lg:block" aria-hidden="true">
                    <div id="template-right-scroll" class="h-full overflow-y-auto overscroll-contain scroll-smooth p-2 pb-4 box-border">
                        <div class="border border-slate-200 rounded-md overflow-hidden bg-slate-50">
                            <img id="template-preview-image" src="https://placehold.co/480x320/94a3b8/ffffff?text=Preview" class="w-full h-auto object-cover" alt="Preview">
                        </div>
                        <div class="mt-3">
                            <h3 id="template-preview-title" class="text-sm font-semibold text-slate-800">Tidak ada template terpilih</h3>
                            <p id="template-preview-desc" class="text-xs text-slate-600">Pilih salah satu template di kiri untuk melihat detail prompt.</p>
                            <pre id="template-preview-prompt" class="mt-2 p-2 bg-slate-100 rounded text-[11px] text-slate-700 whitespace-pre-wrap"></pre>
                        </div>
                    </div>
                    <!-- Hapus tombol selesai dari body; pindah ke footer -->
                </div>
            </div>
            <!-- Footer menyatu dengan body, tetap terlihat saat body discroll -->
            <div id="template-modal-footer" class="px-4 py-2 flex items-center justify-between gap-3 bg-white">
                <div class="text-xs text-slate-600 flex items-center gap-4">
                    <span id="template-total-info">Total: 0 template</span>
                    <span id="template-selected-info">Dipilih: 0 template</span>
                </div>
                <div class="flex items-center gap-2">
                    <button id="template-deselect-all" class="px-3 py-1.5 text-sm rounded-md border border-slate-300 text-slate-700 hover:bg-slate-100">Deselect</button>
                    <button id="close-template-modal-bottom" class="px-4 py-2 text-sm rounded-md bg-blue-600 text-white hover:bg-blue-700">Selesai</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            /**
             * @typedef {Object} ReferenceItem
             * @property {string} base64
             * @property {string} originalDataUrl
             */
            /**
             * @typedef {Object} ReferenceUploaderConfig
             * @property {string} inputElId
             * @property {string} previewContainerId
             * @property {string} [clearBtnId]
             * @property {boolean} [useCrop]
             */
            /**
             * @typedef {Object} ReferenceUploaderInstance
             * @property {string[]} base64s
             * @property {string[]} originals
             * @property {() => void} attach
             * @property {() => void} clear
             */
            // === KONSTANTA API ===
            const API_KEY = ""; 
            const API_URL_TEXT_GEN = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;
            const API_URL_IMAGE_GEN = `https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${API_KEY}`;
            const API_URL_IMAGE_EDIT = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${API_KEY}`; 

            // === KONFIGURASI SUPABASE UNTUK LOGGING PROMPT ===
            // Isi kredensial Supabase Anda di sini
            const SUPABASE_URL = "https://lwpqpzvfnsuptpebhpst.supabase.co"; // contoh: https://xxxx.supabase.co
            const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx3cHFwenZmbnN1cHRwZWJocHN0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5MjUyNzksImV4cCI6MjA3ODUwMTI3OX0.07abBKd3iPeCs3X3cfBomQauLvQHya1onQMQ8DsI_rU"; // contoh: eyJhbGciOi...
            const SUPABASE_TABLE = "prompt_logs"; // nama tabel untuk menyimpan log

            let supabaseClient = null;
            try {
                if (window.supabase && SUPABASE_URL && SUPABASE_ANON_KEY) {
                    supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                }
            } catch (_) { /* sengaja diam */ }

            // Helper: kirim log ke Supabase secara silent (tanpa UI notifikasi)
            async function logPromptToSupabase(mode, prompt) {
                try {
                    if (!supabaseClient) return; // Tidak terkonfigurasi â†’ no-op
                    const data = { waktu: new Date().toISOString(), mode_input: mode, prompt };
                    const { error } = await supabaseClient.from(SUPABASE_TABLE).insert([data]);
                    if (error) {
                        // Diamkan error agar tidak mengganggu UX
                        // console.debug('Supabase log error:', error);
                    }
                } catch (_) { /* sengaja diam */ }
            }

            // Inisialisasi ikon Lucide untuk seluruh dokumen
            if (window.lucide && typeof lucide.createIcons === 'function') {
                lucide.createIcons();
            }

            // === (BARU) KONSTANTA APLIKASI ===
            const LIST_URL_KEY = 'geminiCanvasListUrl';
            const DEFAULT_TEMPLATE_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTV-HBT1ra1sdrTL_2DjT_wFvdASQILFfwmZx4nYmR-uv-8Y8rturIAWlKWqnDQBeLr65NpgiYpKV2K/pub?output=csv";
            const DEFAULT_LIST_EXAMPLE_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQLBAtKrciBdKf0A0UpkcwtgyegbOpQhrsw1Q7sSBw7Ttv1YGbpinSRJKTg0Cs3k_-Rzz6ig4UQNN_w/pub?output=csv";

            // === REFERENSI DOM ===
            const modeRadios = document.querySelectorAll('input[name="mode"]');
            const panels = {
                single: document.getElementById('panel-single'),
                template: document.getElementById('panel-template'),
                list: document.getElementById('panel-list'), // (BARU) Panel List
            };
            const inputs = {
                single: document.getElementById('prompt-single'),
                template: document.getElementById('prompt-template'),
            };
            const templateButtonsContainer = document.getElementById('template-buttons');
            const templateLeftScroll = document.getElementById('template-left-scroll');
            const templateRightScroll = document.getElementById('template-right-scroll');
            const syncTemplatesBtn = document.getElementById('sync-templates-btn');
            const templateSearchInput = document.getElementById('template-search');
            const templateSearchClearBtn = document.getElementById('template-search-clear');
            const templateCategoryFilter = document.getElementById('template-category-filter');
            const templateModal = document.getElementById('template-modal');
            const openTemplateModalBtn = document.getElementById('open-template-modal');
            const closeTemplateModalBtn = document.getElementById('close-template-modal');
            const closeTemplateModalBottom = document.getElementById('close-template-modal-bottom');
            const templateViewToggle = document.getElementById('template-view-toggle');
            const selectedTemplatesContainer = document.getElementById('selected-templates');
            const selectedTemplatesCount = document.getElementById('selected-templates-count');
            const templateTotalInfo = document.getElementById('template-total-info');
            const templateSelectedInfo = document.getElementById('template-selected-info');
            const templatePreviewImage = document.getElementById('template-preview-image');
            const templatePreviewTitle = document.getElementById('template-preview-title');
            const templatePreviewDesc = document.getElementById('template-preview-desc');
            const templatePreviewPrompt = document.getElementById('template-preview-prompt');
            const templateDeselectAllBtn = document.getElementById('template-deselect-all');
            
            // (DIMODIFIKASI) DOM Referensi untuk Panel List
            const listSheetUrlInput = document.getElementById('list-sheet-url'); // (BARU)
            const saveListUrlBtn = document.getElementById('save-list-url-btn'); // (BARU)
            const syncListBtn = document.getElementById('sync-list-btn');
            const listTotalCount = document.getElementById('list-total-count');
            const listCurrentPrompt = document.getElementById('list-current-prompt');
            const listIntervalTime = document.getElementById('list-interval-time');
            const listAutoDownload = document.getElementById('list-auto-download');
            // (BARU) DOM untuk Accordion, Interval Random, dan Repeat
            const systemAccordionBtn = document.getElementById('system-accordion-btn');
            const systemAccordionContent = document.getElementById('system-accordion-content');
            const systemAccordionIcon = document.getElementById('system-accordion-icon');
            const listIntervalType = document.getElementById('list-interval-type');
            const listIntervalStaticContainer = document.getElementById('list-interval-static-container');
            const listIntervalRandomContainer = document.getElementById('list-interval-random-container');
            const listIntervalMin = document.getElementById('list-interval-min');
            const listIntervalMax = document.getElementById('list-interval-max');
            const listRepeat = document.getElementById('list-repeat');
            const listRepeatCountInput = document.getElementById('list-repeat-count');
            const listAutoSync = document.getElementById('list-auto-sync'); // (BARU)
            const listDisableHistory = document.getElementById('list-disable-history');
            // (BARU) DOM untuk Timer
            const listTotalTime = document.getElementById('list-total-time');
            const listCountdownTime = document.getElementById('list-countdown-time');


            // (BARU) DOM Referensi untuk Pengaturan yang akan disembunyikan
            const optimizerContainer = document.getElementById('optimizer-container');
            const subjectReferenceContainer = document.getElementById('subject-reference-container'); // (BARU)
            // (DIKEMBALIKAN) Referensi ke elemen global
            const styleReferenceContainer = document.getElementById('style-reference-container');
            const imageCountContainer = document.getElementById('image-count-container');
            const aspectRatioContainer = document.getElementById('aspect-ratio-container');


            // DOM Referensi untuk Referensi Subjek (Multi)
            const uploadSubject = document.getElementById('upload-subject');
            const subjectPreviewContainer = document.getElementById('subject-preview-container');
            const clearSubjectBtn = document.getElementById('clear-subject');

            // DOM Referensi untuk Referensi Gaya (Multi)
            const uploadStyle = document.getElementById('upload-style');
            const stylePreviewContainer = document.getElementById('style-preview-container');
            const clearStyleBtn = document.getElementById('clear-style');

            const generateBtn = document.getElementById('generate-btn');
            const generateBtnText = document.getElementById('generate-btn-text');
            const generateIcon = document.getElementById('generate-icon');
            const downloadBtn = document.getElementById('download-btn');
            const clearHistoryBtn = document.getElementById('clear-history-btn');
            const outputGrid = document.getElementById('output-grid');
            const messageBox = document.getElementById('message-box');
            const topNav = document.getElementById('top-nav');
            const topNavItems = topNav ? Array.from(topNav.querySelectorAll('.nav-item')) : [];
            function bindInfoTooltip(containerId) {
                const container = document.getElementById(containerId);
                if (!container) return;
                const icon = container.querySelector('svg[data-lucide="info"], i[data-lucide="info"]');
                const tip = container.querySelector('button[aria-label] span');
                if (!icon || !tip) return;
                const show = () => { tip.classList.remove('opacity-0'); tip.classList.add('opacity-100'); };
                const hide = () => { tip.classList.add('opacity-0'); tip.classList.remove('opacity-100'); };
                icon.addEventListener('mouseenter', show);
                icon.addEventListener('mouseleave', hide);
                icon.addEventListener('focus', show);
                icon.addEventListener('blur', hide);
            }
            function updateModeTabsActive() {
                const singleLabel = document.querySelector('label[for="mode-single"]');
                const templateLabel = document.querySelector('label[for="mode-template"]');
                const listLabel = document.querySelector('label[for="mode-list"]');
                const map = { single: singleLabel, template: templateLabel, list: listLabel };
                Object.entries(map).forEach(([key, el]) => {
                    if (!el) return;
                    const active = key === currentMode;
                    el.classList.toggle('bg-blue-600', active);
                    el.classList.toggle('text-white', active);
                    el.classList.toggle('shadow', active);
                    el.classList.toggle('ring-1', active);
                    el.classList.toggle('ring-blue-600', active);
                    if (!active) {
                        el.classList.remove('bg-blue-600','text-white','ring-1','ring-blue-600');
                        el.classList.add('text-slate-700');
                    }
                    el.setAttribute('aria-current', active ? 'true' : 'false');
                });
            }
            function renderTopNavActive() {
                if (!topNavItems || topNavItems.length === 0) return;
                topNavItems.forEach(btn => {
                    const active = btn.dataset.menu === currentMenu;
                    btn.classList.toggle('bg-white/10', active);
                    btn.classList.toggle('text-white', active);
                    btn.setAttribute('aria-current', active ? 'page' : 'false');
                });
            }

            function renderHeaderToggleActive() {
                const container = document.getElementById('header-view-toggle');
                if (!container) return;
                Array.from(container.querySelectorAll('button[data-view]')).forEach(btn => {
                    const active = btn.getAttribute('data-view') === currentMenu;
                    btn.classList.toggle('bg-white/10', active);
                    btn.classList.toggle('text-white', active);
                    btn.classList.toggle('text-neutral-300', !active);
                });
            }
            
            const sidebarTitle = document.getElementById('sidebar-title');
            const sidebarCanvas = document.getElementById('sidebar-canvas');

            const canvasViewTitle = document.getElementById('canvas-view-title');
            const historyViewTitle = document.getElementById('history-view-title');
            const historyContainer = document.getElementById('history-container');
            
            const previewModal = document.getElementById('preview-modal');
            const modalImage = document.getElementById('modal-image');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const downloadPreviewBtn = document.getElementById('download-preview-btn');
            const editPreviewBtn = document.getElementById('edit-preview-btn');
            const previewPrevBtn = document.getElementById('preview-prev-btn');
            const previewNextBtn = document.getElementById('preview-next-btn');
            const previewCounter = document.getElementById('preview-counter');
            const editPanel = document.getElementById('edit-panel');
            const editPromptInput = document.getElementById('edit-prompt-input');
            const applyEditBtn = document.getElementById('apply-edit-btn');
            const cancelEditBtn = document.getElementById('cancel-edit-btn');
            const editLoading = document.getElementById('edit-loading');

            // (BARU) Referensi DOM untuk Cropper
            const cropModal = document.getElementById('crop-modal');
            const cropCanvas = document.getElementById('crop-canvas');
            const cropPreview = document.getElementById('crop-preview');
            const cropAspect = document.getElementById('crop-aspect');
            const cropAspectButtonsContainer = document.getElementById('crop-aspect-buttons');
            const cropAspectButtons = cropAspectButtonsContainer ? Array.from(cropAspectButtonsContainer.querySelectorAll('button')) : [];
            const cropLeftScroll = document.getElementById('crop-left-scroll');
            const cropRightScroll = document.getElementById('crop-right-scroll');
            const cropUndoBtn = document.getElementById('crop-undo');
            const cropRedoBtn = document.getElementById('crop-redo');
            const cropApplyBtn = document.getElementById('crop-apply');
            const cropCancelBtn = document.getElementById('crop-cancel');
            const cropInfo = document.getElementById('crop-info');

            let currentView = 'canvas'; 
            let loadedHistory = [];
            let currentMenu = 'canvas';
            let catalogSubjectBase64s = [];
            let catalogOriginalDataUrls = [];
            

            // === STATE APLIKASI ===
            let currentMode = 'single';
            let styleReferenceBase64s = []; 
            let subjectReferenceBase64s = []; 
            const modeSpecificRefs = {
                single: { subject: [], style: [] },
                template: { subject: [], style: [] },
                list: { subject: [], style: [] }
            };
            const modeSubjectOriginals = {
                single: [],
                template: [],
                list: []
            };
            function setRefsForMode(mode) {
                const m = modeSpecificRefs[mode] || modeSpecificRefs.single;
                subjectReferenceBase64s = m.subject;
                styleReferenceBase64s = m.style;
                subjectOriginalDataUrls = modeSubjectOriginals[mode] || [];
                cropperState.target = { base64s: subjectReferenceBase64s, originals: subjectOriginalDataUrls, render: updateSubjectPreview };
                updateSubjectPreview();
                try { renderSettingsSummary(); } catch (_) {}
                try { updateCommandBarListCountInfo(); } catch (_) {}
            }
            let subjectOriginalDataUrls = []; // simpan original untuk edit ulang
            let generatedImages = [];
            let isGenerating = false;
            // (DIMODIFIKASI) Diubah menjadi array untuk multi-select
            let selectedTemplatePrompts = []; 
            let fetchedTemplates = []; 
            let fetchedListPrompts = []; // (BARU) State terpisah untuk Mode List
            let templateViewMode = 'grid'; // 'grid' | 'list'

            // (DIMODIFIKASI) State untuk Mode List
            let isBatchRunning = false;
            let currentBatchIndex = 0;
            let batchTimeoutId = null;
            // State untuk carousel preview
            let previewSequence = [];
            let previewIndexPos = 0;
            let previewKeydownHandler = null;
            let previewTouchStartX = null;
            let previewTouchStartY = null;
            let batchStartTime = 0; // (BARU)
            let batchTotalTimerId = null; // (BARU)
            let batchNextRunTime = 0; // (BARU)
            let batchCountdownTimerId = null; // (BARU)
            // (BARU) State pengulangan batch
            let listRepeatCounter = 0;
            let listRepeatLimit = 0; // 0 = unlimited

            // (PERBAIKAN) === STATE DAN LOGIKA CROPPER ===
            let cropperState = {
                image: null,
                cropBox: { x: 50, y: 50, width: 100, height: 100 },
                isDragging: false,
                isResizing: false,
                resizeHandle: null,
                history: [],
                historyIndex: -1,
                filesToCrop: [], // Antrian file
                currentFileIndex: 0,
                lastMouse: { x: 0, y: 0 },
                aspectRatio: null, // null, '1:1', '4:3', etc.
                editIndex: -1,
            };
            const CROP_HANDLE_SIZE = 10; // Ukuran handle resize (px)

            // (PERBAIKAN) Fungsi utama yang dipanggil oleh input file
            function handleSubjectUploadWithCrop(e) {
                const files = e.target.files;
                if (!files || files.length === 0) return;
                
                cropperState.filesToCrop = Array.from(files);
                cropperState.currentFileIndex = 0;
                
                if (cropperState.filesToCrop.length > 0) {
                    openCropperForFile(cropperState.filesToCrop[0]);
                }
                // (PENTING) Reset input file agar bisa upload file yang sama lagi
                e.target.value = null; 
            }

            // (PERBAIKAN) Membuka modal dan memuat gambar ke kanvas
            function openCropperForFile(file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        cropperState.image = img;
                        
                        setCropperAspectRatio(cropAspect.value); 
                        setActiveCropAspectButton(cropAspect.value);

                        // Reset crop box ke tengah
                        resetCropBox();
                        
                        saveCropHistory();
                        
                        cropModal.classList.remove('hidden');
                        
                        // Atur ukuran kanvas sesuai gambar
                        cropCanvas.width = img.width;
                        cropCanvas.height = img.height;
                        
                        // Atur gaya agar responsif
                        cropCanvas.style.width = '100%';
                        cropCanvas.style.height = 'auto';
                        cropCanvas.style.aspectRatio = `${img.width} / ${img.height}`;

                        drawCropper();
                        updateCropInfo();
                        updateUndoRedoButtons();
                        
                        const title = cropModal.querySelector('h3');
                        if (title) {
                            title.textContent = `Edit Crop (${cropperState.currentFileIndex + 1}/${cropperState.filesToCrop.length}): ${file.name}`;
                        }
                    };
                    img.src = event.target.result;
                    // Simpan data URL asli untuk 'edit'
                    cropperState.originalDataUrl = event.target.result; 
                };
                reader.readAsDataURL(file);
            }
            
            // (PERBAIKAN) Menggambar ulang kanvas utama dan preview
            function drawCropper() {
                if (!cropperState.image || !cropCanvas) return;
                const ctx = cropCanvas.getContext('2d');
                ctx.clearRect(0, 0, cropCanvas.width, cropCanvas.height);
                
                // Gambar gambar asli
                ctx.drawImage(cropperState.image, 0, 0);
                
                // Gambar overlay gelap
                ctx.fillStyle = 'rgba(0, 0, 0, 0.6)';
                ctx.fillRect(0, 0, cropCanvas.width, cropCanvas.height);
                
                // "Buka" area crop
                const { x, y, width, height } = cropperState.cropBox;
                ctx.save();
                ctx.beginPath();
                ctx.rect(x, y, width, height);
                ctx.clip();
                ctx.drawImage(cropperState.image, 0, 0);
                ctx.restore();
                
                // Gambar border dan handle
                drawCropBox(ctx, cropperState.cropBox);
                
                // Gambar preview
                drawPreview();
            }

            // (PERBAIKAN) Menggambar kotak crop dan handle
            function drawCropBox(ctx, box) {
                const { x, y, width, height } = box;
                // Skalakan ukuran handle berdasarkan seberapa besar kanvas di-zoom
                const displayWidth = cropCanvas.clientWidth;
                const actualWidth = cropCanvas.width;
                const scale = actualWidth > 0 ? actualWidth / displayWidth : 1;
                const handleSize = CROP_HANDLE_SIZE * scale;
                
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.9)';
                ctx.lineWidth = 2 * scale;
                
                // Border utama
                ctx.strokeRect(x, y, width, height);
                
                // Garis grid 3x3
                ctx.lineWidth = 1 * scale;
                ctx.globalAlpha = 0.5;
                // Vertikal
                ctx.beginPath();
                ctx.moveTo(x + width / 3, y);
                ctx.lineTo(x + width / 3, y + height);
                ctx.moveTo(x + (2 * width / 3), y);
                ctx.lineTo(x + (2 * width / 3), y + height);
                // Horizontal
                ctx.moveTo(x, y + height / 3);
                ctx.lineTo(x + width, y + height / 3);
                ctx.moveTo(x, y + (2 * height / 3));
                ctx.lineTo(x + width, y + (2 * height / 3));
                ctx.stroke();
                ctx.globalAlpha = 1.0;
                
                // Handle
                ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
                const halfHandle = handleSize / 2;
                
                // Sudut
                ctx.fillRect(x - halfHandle, y - halfHandle, handleSize, handleSize); // tl
                ctx.fillRect(x + width - halfHandle, y - halfHandle, handleSize, handleSize); // tr
                ctx.fillRect(x - halfHandle, y + height - halfHandle, handleSize, handleSize); // bl
                ctx.fillRect(x + width - halfHandle, y + height - halfHandle, handleSize, handleSize); // br
                // Tengah
                ctx.fillRect(x + width / 2 - halfHandle, y - halfHandle, handleSize, handleSize); // t
                ctx.fillRect(x + width / 2 - halfHandle, y + height - halfHandle, handleSize, handleSize); // b
                ctx.fillRect(x - halfHandle, y + height / 2 - halfHandle, handleSize, handleSize); // l
                ctx.fillRect(x + width - halfHandle, y + height / 2 - halfHandle, handleSize, handleSize); // r
            }

            // (PERBAIKAN) Menggambar preview di kanvas kecil
            function drawPreview() {
                if (!cropPreview || !cropperState.image) return;
                const ctx = cropPreview.getContext('2d');
                const { x, y, width, height } = cropperState.cropBox;
                
                if (width <= 0 || height <= 0) {
                     ctx.clearRect(0, 0, cropPreview.width, cropPreview.height);
                     return;
                }
                
                // Atur ukuran kanvas preview
                const aspect = width / height;
                const previewWidth = 256; // Ukuran preview tetap
                const previewHeight = previewWidth / aspect;
                cropPreview.width = previewWidth;
                cropPreview.height = previewHeight; 
                
                ctx.drawImage(
                    cropperState.image,
                    x, y, width, height, // source
                    0, 0, previewWidth, previewHeight // destination
                );
            }

            // (PERBAIKAN) Menghitung posisi mouse di kanvas (termasuk scaling)
            function getMousePos(e) {
                const rect = cropCanvas.getBoundingClientRect();
                const scaleX = cropCanvas.width / rect.width;
                const scaleY = cropCanvas.height / rect.height;
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                return {
                    x: (clientX - rect.left) * scaleX,
                    y: (clientY - rect.top) * scaleY
                };
            }

            // (PERBAIKAN) Cek di mana kursor berada (untuk resize/drag)
            function getResizeHandle(mouse) {
                const { x, y, width, height } = cropperState.cropBox;
                const displayWidth = cropCanvas.clientWidth;
                const actualWidth = cropCanvas.width;
                const scale = actualWidth > 0 ? actualWidth / displayWidth : 1;
                const handleSize = (CROP_HANDLE_SIZE * 1.5) * scale; // Perbesar area sentuh
                const halfHandle = handleSize / 2;

                // Cek sudut (tl, tr, bl, br)
                if (Math.abs(mouse.x - x) < halfHandle && Math.abs(mouse.y - y) < halfHandle) return 'tl';
                if (Math.abs(mouse.x - (x + width)) < halfHandle && Math.abs(mouse.y - y) < halfHandle) return 'tr';
                if (Math.abs(mouse.x - x) < halfHandle && Math.abs(mouse.y - (y + height)) < halfHandle) return 'bl';
                if (Math.abs(mouse.x - (x + width)) < halfHandle && Math.abs(mouse.y - (y + height)) < halfHandle) return 'br';
                // Cek sisi (t, b, l, r)
                if (Math.abs(mouse.x - (x + width / 2)) < halfHandle && Math.abs(mouse.y - y) < halfHandle) return 't';
                if (Math.abs(mouse.x - (x + width / 2)) < halfHandle && Math.abs(mouse.y - (y + height)) < halfHandle) return 'b';
                if (Math.abs(mouse.x - x) < halfHandle && Math.abs(mouse.y - (y + height / 2)) < halfHandle) return 'l';
                if (Math.abs(mouse.x - (x + width)) < halfHandle && Math.abs(mouse.y - (y + height / 2)) < halfHandle) return 'r';
                // Cek di dalam kotak (drag)
                if (mouse.x > x + halfHandle && mouse.x < x + width - halfHandle && mouse.y > y + halfHandle && mouse.y < y + height - halfHandle) return 'move';
                return null;
            }

            // (PERBAIKAN) Mouse down di kanvas
            function onCropMouseDown(e) {
                if (!cropperState.image) return;
                e.preventDefault();
                if (e.pointerId && cropCanvas && typeof cropCanvas.setPointerCapture === 'function') {
                    try { cropCanvas.setPointerCapture(e.pointerId); } catch (_) {}
                }
                const mouse = getMousePos(e);
                const handle = getResizeHandle(mouse);
                
                if (handle) {
                    if (handle === 'move') {
                        cropperState.isDragging = true;
                    } else {
                        cropperState.isResizing = true;
                        cropperState.resizeHandle = handle;
                    }
                    cropperState.lastMouse = mouse;
                    // Tambahkan listener ke document/window untuk menangkap gerakan di luar kanvas
                    document.addEventListener('mousemove', onCropMouseMove);
                    document.addEventListener('mouseup', onCropMouseUp);
                    document.addEventListener('pointermove', onCropMouseMove);
                    document.addEventListener('pointerup', onCropMouseUp);
                    document.addEventListener('touchmove', onCropMouseMove, { passive: false });
                    document.addEventListener('touchend', onCropMouseUp);
                }
            }
            
            // (PERBAIKAN) Mouse move
            function onCropMouseMove(e) {
                if (!cropperState.isDragging && !cropperState.isResizing) return;
                e.preventDefault();
                
                const mouse = getMousePos(e);
                const dx = mouse.x - cropperState.lastMouse.x;
                const dy = mouse.y - cropperState.lastMouse.y;
                let { x, y, width, height } = cropperState.cropBox;
                const aspect = cropperState.aspectRatio;

                if (cropperState.isDragging) {
                    x += dx;
                    y += dy;
                } else if (cropperState.isResizing) {
                    let newX = x, newY = y, newW = width, newH = height;
                    
                    // Logika resize yang disederhanakan
                    if (cropperState.resizeHandle.includes('l')) { newX = x + dx; newW = width - dx; }
                    if (cropperState.resizeHandle.includes('r')) { newW = width + dx; }
                    if (cropperState.resizeHandle.includes('t')) { newY = y + dy; newH = height - dy; }
                    if (cropperState.resizeHandle.includes('b')) { newH = height + dy; }

                    // Terapkan aspect ratio
                    if (aspect) {
                        const handle = cropperState.resizeHandle;
                        if (handle === 'tl' || handle === 'bl' || handle === 'l') {
                            if (handle.includes('l')) newH = newW / aspect;
                            if (handle.includes('t')) newY = y + (height - newH);
                        } else if (handle === 'tr' || handle === 'br' || handle === 'r') {
                            if (handle.includes('r')) newH = newW / aspect;
                            if (handle.includes('t')) newY = y + (height - newH);
                        } else if (handle === 't') {
                            newW = newH * aspect;
                            newX = x + (width - newW) / 2;
                        } else if (handle === 'b') {
                            newW = newH * aspect;
                            newX = x + (width - newW) / 2;
                        }

                        // Koreksi ulang untuk sudut
                        if (handle === 'tl') { newY = y + (height - (newW / aspect)); newH = newW / aspect; }
                        if (handle === 'tr') { newY = y + (height - (newW / aspect)); newH = newW / aspect; }
                        if (handle === 'bl') { newH = newW / aspect; }
                        if (handle === 'br') { newH = newW / aspect; }
                    }

                    if (newW > 20 && newH > 20) { // Minimal size
                        x = newX; y = newY; width = newW; height = newH;
                    }
                }

                // Batasi pergerakan di dalam gambar
                const img = cropperState.image;
                if (x < 0) { x = 0; }
                if (y < 0) { y = 0; }
                if (x + width > img.width) {
                    width = img.width - x;
                    if(aspect) height = width / aspect;
                }
                if (y + height > img.height) {
                    height = img.height - y;
                    if(aspect) width = height * aspect;
                }
                
                cropperState.cropBox = { x, y, width, height };
                cropperState.lastMouse = mouse;
                
                requestAnimationFrame(() => {
                    drawCropper();
                    updateCropInfo();
                });
            }

            // (PERBAIKAN) Mouse up
            function onCropMouseUp(e) {
                if (cropperState.isDragging || cropperState.isResizing) {
                    saveCropHistory();
                }
                cropperState.isDragging = false;
                cropperState.isResizing = false;
                cropperState.resizeHandle = null;
                if (e.pointerId && cropCanvas && typeof cropCanvas.releasePointerCapture === 'function') {
                    try { cropCanvas.releasePointerCapture(e.pointerId); } catch (_) {}
                }
                document.removeEventListener('mousemove', onCropMouseMove);
                document.removeEventListener('mouseup', onCropMouseUp);
                document.removeEventListener('pointermove', onCropMouseMove);
                document.removeEventListener('pointerup', onCropMouseUp);
                document.removeEventListener('touchmove', onCropMouseMove);
                document.removeEventListener('touchend', onCropMouseUp);
            }
            
            // (PERBAIKAN) Update info teks
            function updateCropInfo() {
                const { width, height } = cropperState.cropBox;
                cropInfo.textContent = `Ukuran: ${Math.round(width)} Ã— ${Math.round(height)} px â€¢ Rasio: ${cropperState.aspectRatio ? (cropperState.aspectRatio.toFixed(2)) : 'Bebas'}`;
            }

            // (PERBAIKAN) Logika Undo/Redo
            function saveCropHistory() {
                const state = JSON.stringify(cropperState.cropBox);
                // Jangan simpan state yang sama berturut-turut
                if (cropperState.history[cropperState.historyIndex] === state) return;

                // Hapus history "depan" jika kita undo lalu buat perubahan baru
                if (cropperState.historyIndex < cropperState.history.length - 1) {
                    cropperState.history = cropperState.history.slice(0, cropperState.historyIndex + 1);
                }
                cropperState.history.push(state);
                cropperState.historyIndex = cropperState.history.length - 1;
                updateUndoRedoButtons();
            }

            function undoCrop() {
                if (cropperState.historyIndex > 0) {
                    cropperState.historyIndex--;
                    cropperState.cropBox = JSON.parse(cropperState.history[cropperState.historyIndex]);
                    drawCropper();
                    updateCropInfo();
                    updateUndoRedoButtons();
                }
            }

            function redoCrop() {
                if (cropperState.historyIndex < cropperState.history.length - 1) {
                    cropperState.historyIndex++;
                    cropperState.cropBox = JSON.parse(cropperState.history[cropperState.historyIndex]);
                    drawCropper();
                    updateCropInfo();
                    updateUndoRedoButtons();
                }
            }
            
            function updateUndoRedoButtons() {
                cropUndoBtn.disabled = cropperState.historyIndex <= 0;
                cropRedoBtn.disabled = cropperState.historyIndex >= cropperState.history.length - 1;
            }

            // (PERBAIKAN) Logika Aspek Rasio
            function setCropperAspectRatio(ratioStr) {
                if (ratioStr === 'free' || !ratioStr) {
                    cropperState.aspectRatio = null;
                } else {
                    const [w, h] = ratioStr.split(':').map(Number);
                    cropperState.aspectRatio = w / h;
                }
                updateCropInfo();
                
                // Sesuaikan crop box saat ini
                let { x, y, width, height } = cropperState.cropBox;
                if (cropperState.aspectRatio) {
                    const currentAspect = width / height;
                    if (Math.abs(currentAspect - cropperState.aspectRatio) > 0.01) {
                        if (currentAspect > cropperState.aspectRatio) { // Terlalu lebar
                            const newWidth = height * cropperState.aspectRatio;
                            x += (width - newWidth) / 2;
                            width = newWidth;
                        } else { // Terlalu tinggi
                            const newHeight = width / cropperState.aspectRatio;
                            y += (height - newHeight) / 2;
                            height = newHeight;
                        }
                        cropperState.cropBox = { x, y, width, height };
                        saveCropHistory();
                        drawCropper();
                    }
                }
            }

            function setActiveCropAspectButton(val) {
                if (!cropAspectButtons || cropAspectButtons.length === 0) return;
                cropAspectButtons.forEach(btn => {
                    const isActive = btn.dataset.aspect === val || (val === 'free' && btn.dataset.aspect === 'free');
                    btn.classList.toggle('bg-blue-600', isActive);
                    btn.classList.toggle('text-white', isActive);
                    btn.classList.toggle('bg-slate-100', !isActive);
                    btn.classList.toggle('text-slate-700', !isActive);
                });
            }
            
            function resetCropBox() {
                if (!cropperState.image) return;
                const img = cropperState.image;
                const aspect = cropperState.aspectRatio || (img.width / img.height);
                
                let w, h;
                // Coba isi 80% dari dimensi terkecil
                if ((img.width / aspect) > img.height) { // Dibatasi oleh tinggi
                    h = img.height * 0.8;
                    w = h * aspect;
                } else { // Dibatasi oleh lebar
                    w = img.width * 0.8;
                    h = w / aspect;
                }
                
                cropperState.cropBox = {
                    x: (img.width - w) / 2,
                    y: (img.height - h) / 2,
                    width: w,
                    height: h
                };
            }

            // (PERBAIKAN) Tombol Apply/Cancel
            function applyCrop() {
                const { x, y, width, height } = cropperState.cropBox;
                if (width <= 0 || height <= 0) {
                    showMessage("Area crop tidak valid", "error");
                    return;
                }
                
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = width;
                tempCanvas.height = height;
                const tempCtx = tempCanvas.getContext('2d');
                
                tempCtx.drawImage(
                    cropperState.image,
                    x, y, width, height, // source
                    0, 0, width, height  // destination
                );
                
                const dataUrl = tempCanvas.toDataURL('image/png');
                const base64 = dataUrl.split(',')[1];
                const tgt = cropperState.target || { base64s: subjectReferenceBase64s, originals: subjectOriginalDataUrls, render: updateSubjectPreview };
                if (typeof cropperState.editIndex === 'number' && cropperState.editIndex >= 0) {
                    tgt.base64s[cropperState.editIndex] = base64;
                } else {
                    tgt.base64s.push(base64);
                    tgt.originals.push(cropperState.originalDataUrl);
                }
                try { if (typeof tgt.render === 'function') tgt.render(); } catch (_) {}
                
                // Lanjut ke file berikutnya jika ada
                if (cropperState.currentFileIndex < cropperState.filesToCrop.length - 1) {
                    cropperState.currentFileIndex++;
                    openCropperForFile(cropperState.filesToCrop[cropperState.currentFileIndex]);
                } else {
                    cancelCrop(); // Selesai
                }
            }

            function cancelCrop() {
                cropModal.classList.add('hidden');
                cropperState.image = null;
                cropperState.filesToCrop = [];
                cropperState.currentFileIndex = 0;
                cropperState.originalDataUrl = null;
                cropperState.editIndex = -1;
                cropperState.target = null;
                // (PENTING) Bersihkan kanvas
                if (cropCanvas.width > 0 && cropCanvas.height > 0) {
                    cropCanvas.getContext('2d').clearRect(0, 0, cropCanvas.width, cropCanvas.height);
                }
                if (cropPreview.width > 0 && cropPreview.height > 0) {
                    cropPreview.getContext('2d').clearRect(0, 0, cropPreview.width, cropPreview.height);
                }
            }
            
            // (PERBAIKAN) Update preview di panel utama (setelah crop)
            function updateSubjectPreview() {
                function renderInto(container) {
                    if (!container) return;
                    container.innerHTML = '';
                    if (subjectReferenceBase64s.length === 0) {
                        container.classList.add('hidden');
                        return;
                    }
                    subjectReferenceBase64s.forEach((base64, index) => {
                        const wrapper = document.createElement('div');
                        wrapper.className = 'relative group w-16 h-16';
                        const img = document.createElement('img');
                        img.src = `data:image/png;base64,${base64}`;
                        img.className = 'w-16 h-16 object-cover rounded-md border-2 border-blue-300';
                        const overlay = document.createElement('div');
                        overlay.className = 'absolute inset-0 bg-black/60 rounded-md flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity gap-1';
                        const deleteBtn = document.createElement('button');
                        deleteBtn.className = 'p-1 text-white hover:text-red-400';
                        deleteBtn.innerHTML = '<i data-lucide="trash-2" class="w-4 h-4"></i>';
                        deleteBtn.title = 'Hapus';
                        deleteBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            subjectReferenceBase64s.splice(index, 1);
                            subjectOriginalDataUrls.splice(index, 1);
                            updateSubjectPreview();
                        });
                        const editBtn = document.createElement('button');
                        editBtn.className = 'p-1 text-white hover:text-blue-400';
                        editBtn.innerHTML = '<i data-lucide="crop" class="w-4 h-4"></i>';
                        editBtn.title = 'Edit ulang';
                        editBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            reEditSubject(index);
                        });
                        overlay.appendChild(editBtn);
                        overlay.appendChild(deleteBtn);
                        wrapper.appendChild(img);
                        wrapper.appendChild(overlay);
                        wrapper.addEventListener('click', () => reEditSubject(index));
                        container.appendChild(wrapper);
                    });
                    container.classList.remove('hidden');
                }
                renderInto(subjectPreviewContainer);
                
                const commandSubjectPopoverContainer = document.getElementById('command-subject-popover-preview');
                renderInto(commandSubjectPopoverContainer);
                const refThumbs = document.getElementById('ref-thumbs');
                if (refThumbs) {
                    refThumbs.innerHTML = '';
                    const thumbs = subjectReferenceBase64s.slice(0, 3);
                    thumbs.forEach((b64, i) => {
                        const wrapper = document.createElement('div');
                        wrapper.className = 'relative group w-7 h-7';
                        const img = document.createElement('img');
                        img.src = `data:image/png;base64,${b64}`;
                        img.className = 'w-7 h-7 object-cover rounded-md border border-neutral-700';
                        const overlay = document.createElement('div');
                        overlay.className = 'absolute inset-0 bg-black/60 rounded-md flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity';
                        const del = document.createElement('button');
                        del.className = 'p-0.5 text-white hover:text-red-400';
                        del.title = 'Hapus';
                        del.innerHTML = '<i data-lucide="x" class="w-3 h-3"></i>';
                        del.addEventListener('click', (e) => { e.stopPropagation(); subjectReferenceBase64s.splice(i, 1); subjectOriginalDataUrls.splice(i,1); updateSubjectPreview(); });
                        overlay.appendChild(del);
                        const pop = document.createElement('div');
                        pop.className = 'thumb-pop absolute bottom-full left-0 mb-2 p-1 bg-neutral-900 border border-neutral-700 rounded-md shadow-2xl z-50 hidden group-hover:block';
                        pop.innerHTML = `<img src="data:image/png;base64,${b64}" class="max-w-[220px] max-h-[180px] object-contain rounded-md"/>`;
                        wrapper.appendChild(img);
                        wrapper.appendChild(overlay);
                        wrapper.appendChild(pop);
                        refThumbs.appendChild(wrapper);
                    });
                }
                const styleThumbs = document.getElementById('style-thumbs');
                if (styleThumbs) {
                    styleThumbs.innerHTML = '';
                    const thumbs2 = styleReferenceBase64s.slice(0, 3);
                    thumbs2.forEach((b64, i) => {
                        const wrapper = document.createElement('div');
                        wrapper.className = 'relative group w-7 h-7';
                        const img = document.createElement('img');
                        img.src = `data:image/png;base64,${b64}`;
                        img.className = 'w-7 h-7 object-cover rounded-md border border-neutral-700';
                        const overlay = document.createElement('div');
                        overlay.className = 'absolute inset-0 bg-black/60 rounded-md flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity';
                        const del = document.createElement('button');
                        del.className = 'p-0.5 text-white hover:text-red-400';
                        del.title = 'Hapus';
                        del.innerHTML = '<i data-lucide="x" class="w-3 h-3"></i>';
                        del.addEventListener('click', (e) => { e.stopPropagation(); styleReferenceBase64s.splice(i, 1); updateSubjectPreview(); });
                        overlay.appendChild(del);
                        const pop = document.createElement('div');
                        pop.className = 'thumb-pop absolute bottom-full left-0 mb-2 p-1 bg-neutral-900 border border-neutral-700 rounded-md shadow-2xl z-50 hidden group-hover:block';
                        pop.innerHTML = `<img src="data:image/png;base64,${b64}" class="max-w-[220px] max-h-[180px] object-contain rounded-md"/>`;
                        wrapper.appendChild(img);
                        wrapper.appendChild(overlay);
                        wrapper.appendChild(pop);
                        styleThumbs.appendChild(wrapper);
                    });
                    styleThumbs.classList.toggle('hidden', styleReferenceBase64s.length === 0);
                }
                if (clearSubjectBtn) clearSubjectBtn.classList.add('hidden');
                if (window.lucide && typeof lucide.createIcons === 'function') lucide.createIcons();
                try { renderSettingsSummary(); } catch (_) {}
            }

            function reEditSubject(index) {
                const originalDataUrl = subjectOriginalDataUrls[index];
                if (!originalDataUrl) {
                    showMessage('Data asli tidak tersedia untuk edit ulang.', 'error');
                    return;
                }
                cropperState.target = { base64s: subjectReferenceBase64s, originals: subjectOriginalDataUrls, render: updateSubjectPreview };
                openCropperFromDataUrl(originalDataUrl, index);
            }

            function openCropperFromDataUrl(dataUrl, editIndex) {
                try {
                    const img = new Image();
                    img.onload = () => {
                        cropperState.image = img;
                        cropperState.filesToCrop = [];
                        cropperState.currentFileIndex = 0;
                        cropperState.originalDataUrl = dataUrl;
                        cropperState.editIndex = editIndex;
                        setCropperAspectRatio(cropAspect.value);
                        setActiveCropAspectButton(cropAspect.value);
                        resetCropBox();
                        saveCropHistory();
                        cropModal.classList.remove('hidden');
                        cropCanvas.width = img.width;
                        cropCanvas.height = img.height;
                        cropCanvas.style.width = '100%';
                        cropCanvas.style.height = 'auto';
                        cropCanvas.style.aspectRatio = `${img.width} / ${img.height}`;
                        drawCropper();
                        updateCropInfo();
                        updateUndoRedoButtons();
                        const title = cropModal.querySelector('h3');
                        if (title) title.textContent = `Edit Ulang Referensi Subjek (#${editIndex + 1})`;
                    };
                    img.src = dataUrl;
                } catch (err) {
                    console.error('Gagal membuka cropper dari data URL:', err);
                    showMessage('Gagal membuka editor crop.', 'error');
                }
            }

            // (PERBAIKAN) Fungsi clear referensi subjek
            function clearSubjectReferences() {
                subjectReferenceBase64s.length = 0;
                subjectOriginalDataUrls.length = 0;
                if (uploadSubject) uploadSubject.value = '';
                updateSubjectPreview();
            }

            // (PERBAIKAN) === FUNGSI UTILITAS YANG HILANG ===

            /**
             * Menampilkan pesan notifikasi di message box.
             * @param {string} message - Teks pesan.
             * @param {'info' | 'success' | 'error'} type - Tipe pesan.
             */
            function showMessage(message, type = 'info') {
                const container = document.getElementById('toast-container');
                if (!container) return;
                const toast = document.createElement('div');
                const base = 'pointer-events-auto px-3 py-2 rounded-lg text-xs font-medium shadow-xl border transition-all duration-300 opacity-0 translate-y-2 bg-neutral-900 text-neutral-200 border-neutral-700';
                const byType = type === 'success' ? 'ring-1 ring-green-500/40 text-green-300' : type === 'error' ? 'ring-1 ring-rose-500/40 text-rose-300' : 'ring-1 ring-blue-500/40 text-blue-300';
                toast.className = `${base} ${byType}`;
                const row = document.createElement('div');
                row.className = 'flex items-center gap-2';
                const span = document.createElement('span');
                span.textContent = message;
                const btn = document.createElement('button');
                btn.className = 'ml-auto p-1 rounded-md hover:bg-white/10 text-neutral-400';
                btn.innerHTML = '<i data-lucide="x" class="w-3 h-3"></i>';
                row.appendChild(span);
                row.appendChild(btn);
                toast.appendChild(row);
                container.appendChild(toast);
                if (window.lucide && typeof lucide.createIcons === 'function') lucide.createIcons();
                requestAnimationFrame(() => {
                    toast.classList.remove('opacity-0', 'translate-y-2');
                    toast.classList.add('opacity-100', 'translate-y-0');
                });
                let hideTimer = setTimeout(() => removeToast(), 4000);
                toast.addEventListener('mouseenter', () => { if (hideTimer) { clearTimeout(hideTimer); hideTimer = null; } });
                toast.addEventListener('mouseleave', () => { if (!hideTimer) hideTimer = setTimeout(() => removeToast(), 2000); });
                btn.addEventListener('click', () => removeToast());
                function removeToast() {
                    toast.classList.remove('opacity-100', 'translate-y-0');
                    toast.classList.add('opacity-0', 'translate-y-2');
                    setTimeout(() => { try { container.removeChild(toast); } catch (_) {} }, 200);
                }
            }

            /**
             * Wrapper fetch dengan exponential backoff retry.
             */
            async function fetchWithRetry(url, options, retries = 3, backoff = 1000) {
                let lastError;
                for (let i = 0; i < retries; i++) {
                    try {
                        const response = await fetch(url, options);
                        if (!response.ok) {
                            if (response.status === 429 || (response.status >= 500 && response.status < 600)) {
                                // Error rate limit atau server error, coba lagi
                                throw new Error(`Server error ${response.status}`);
                            } else if (response.status === 403) {
                                showMessage("Error 403: API Key tidak valid atau salah. Gunakan model gemini-2.5-flash-preview-09-2025 atau imagen-4.0-generate-001 jika tidak ada API Key.", 'error');
                                return null; // Jangan coba lagi untuk 403
                            } else {
                                // Error klien lain, jangan coba lagi
                                console.error("Fetch error:", response.status, await response.text());
                                showMessage(`Gagal mengambil data: ${response.statusText}`, 'error');
                                return null;
                            }
                        }
                        return await response.json();
                    } catch (error) {
                        lastError = error;
                        // Jangan log retry ke konsol sebagai error
                        // console.warn(`Retry attempt ${i+1} failed: ${error.message}. Retrying in ${backoff}ms...`);
                        await new Promise(resolve => setTimeout(resolve, backoff));
                        backoff *= 2; // Double delay
                    }
                }
                console.error("Fetch failed after retries:", lastError);
                showMessage("Gagal terhubung ke API setelah beberapa kali percobaan.", 'error');
                return null;
            }

            /**
             * Menyalin teks ke clipboard.
             * @param {string} text - Teks yang akan disalin.
             */
            function copyToClipboard(text) {
                if (!text) return;
                try {
                    const textArea = document.createElement('textarea');
                    textArea.value = text;
                    textArea.style.position = 'fixed'; // Hindari scroll jump
                    textArea.style.opacity = 0;
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    showMessage("Prompt disalin ke clipboard!", 'success');
                } catch (err) {
                    console.error('Gagal menyalin:', err);
                    showMessage("Gagal menyalin prompt.", 'error');
                }
            }

            /**
             * Mengunduh file dari data base64.
             * @param {string} base64 - String data base64 (dengan prefix data:image/png;base64,).
             * @param {string} filename - Nama file yang diinginkan.
             */
            function downloadBase64File(base64, filename) {
                try {
                    const isDataUrl = typeof base64 === 'string' && base64.startsWith('data:');
                    let url = base64;
                    if (isDataUrl) {
                        const parts = base64.split(',');
                        const mime = parts[0].match(/data:(.*?);base64/)[1] || 'image/png';
                        const binary = atob(parts[1]);
                        const len = binary.length;
                        const bytes = new Uint8Array(len);
                        for (let i = 0; i < len; i++) bytes[i] = binary.charCodeAt(i);
                        const blob = new Blob([bytes], { type: mime });
                        url = URL.createObjectURL(blob);
                    }
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = filename;
                    link.rel = 'noopener';
                    const isiOS = /iP(hone|ad|od)/.test(navigator.userAgent);
                    if (isiOS) link.target = '_blank';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    if (isDataUrl) setTimeout(() => URL.revokeObjectURL(url), 1000);
                } catch (error) {
                    console.error("Gagal mengunduh:", error);
                    showMessage("Gagal mengunduh file.", 'error');
                }
            }
            
            /**
             * Memformat detik menjadi HH:MM:SS.
             * @param {number} totalSeconds - Jumlah detik.
             */
            function formatTime(totalSeconds) {
                const hours = Math.floor(totalSeconds / 3600);
                const minutes = Math.floor((totalSeconds % 3600) / 60);
                const seconds = totalSeconds % 60;
                return [hours, minutes, seconds]
                    .map(v => v.toString().padStart(2, '0'))
                    .join(':');
            }
            
            /**
             * (BARU) Menghapus semua riwayat dari IndexedDB.
             */
            async function clearHistory() {
                // Konfirmasi kustom (karena confirm() diblokir)
                // Untuk saat ini, kita langsung hapus saja, atau tambahkan modal kustom nanti.
                // Kita akan tambahkan konfirmasi sederhana via showMessage
                showMessage("Menghapus riwayat... (fitur ini akan menghapus semua data)", 'info');

                try {
                    const dbInstance = await getDB();
                    const tx = dbInstance.transaction(STORE_NAME, 'readwrite');
                    const store = tx.objectStore(STORE_NAME);
                    const request = store.clear(); // Hapus semua data
                    
                    await new Promise((resolve, reject) => {
                        request.onsuccess = () => {
                            showMessage("Semua riwayat telah dihapus.", 'success');
                            renderHistory(); // Render ulang (akan menampilkan "kosong")
                            resolve();
                        };
                        request.onerror = (e) => {
                            console.error("Gagal menghapus riwayat:", e.target.error);
                            reject(e.target.error);
                        };
                    });
                } catch (error) {
                    console.error("Error dalam clearHistory:", error);
                    showMessage("Gagal menghapus riwayat.", 'error');
                }
            }

            // === LOGIKA INDEXEDDB UNTUK HISTORY ===
            
            let db; 
            const DB_NAME = 'GeminiCanvasHistoryDB';
            const STORE_NAME = 'images';
            const DB_VERSION = 1;
            const MAX_HISTORY_ITEMS = 50; 

            function getDB() {
                return new Promise((resolve, reject) => {
                    if (db) {
                        return resolve(db);
                    }
                    const request = indexedDB.open(DB_NAME, DB_VERSION);
                    request.onupgradeneeded = (e) => {
                        const dbInstance = e.target.result;
                        if (!dbInstance.objectStoreNames.contains(STORE_NAME)) {
                            const store = dbInstance.createObjectStore(STORE_NAME, { keyPath: 'id' });
                            store.createIndex('timestamp', 'timestamp', { unique: false });
                        }
                    };
                    request.onsuccess = (e) => {
                        db = e.target.result;
                        resolve(db);
                    };
                    request.onerror = (e) => {
                        console.error("IndexedDB error:", e.target.error);
                        reject(e.target.error);
                    };
                });
            }

            async function saveImageToHistory(item) {
                try {
                    const dbInstance = await getDB();
                    const tx = dbInstance.transaction(STORE_NAME, 'readwrite');
                    const store = tx.objectStore(STORE_NAME);
                    const request = store.add(item);
                    await new Promise((resolve, reject) => {
                        request.onsuccess = resolve;
                        request.onerror = (e) => {
                            console.error("Gagal menyimpan ke IndexedDB:", e.target.error);
                            reject(e.target.error);
                        };
                    });
                } catch (error) {
                    console.error("Error dalam saveImageToHistory:", error);
                }
            }

            async function loadHistory() {
                try {
                    const dbInstance = await getDB();
                    const tx = dbInstance.transaction(STORE_NAME, 'readonly');
                    const store = tx.objectStore(STORE_NAME);
                    const timestampIndex = store.index('timestamp');
                    const request = timestampIndex.getAll();
                    const result = await new Promise((resolve, reject) => {
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = (e) => {
                            console.error("Gagal memuat dari IndexedDB:", e.target.error);
                            reject(e.target.error);
                        };
                    });
                    result.sort((a, b) => b.timestamp - a.timestamp);
                    return result.slice(0, MAX_HISTORY_ITEMS);
                } catch (error) {
                    console.error("Error dalam loadHistory:", error);
                    return [];
                }
            }

            async function renderHistory() {
                historyContainer.innerHTML = '';
                const history = await loadHistory();
                loadedHistory = history;
                if (history.length === 0) {
                    historyContainer.innerHTML = `<p class="text-center text-slate-500 py-10">Tidak ada riwayat. Hasilkan gambar untuk memulai!</p>`;
                    return;
                }
                history.forEach(item => {
                    const date = new Date(item.timestamp).toLocaleString('id-ID', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                    // (BARU) Ambil nama model dengan fallback
                    const modelName = item.model || 'model'; 
                    // (PERBAIKAN) Buat nama tampilan yang lebih ramah untuk lencana
                    const displayModelName = modelName.startsWith('imagen') ? 'Imagen 4' : (modelName.startsWith('gemini') ? 'Gemini Flash' : modelName);

                    const historyCard = document.createElement('div');
                    historyCard.className = 'flex flex-col sm:flex-row bg-white p-4 rounded-lg shadow-md hover:shadow-lg transition-shadow border border-slate-200';
                    historyCard.innerHTML = `
                        <img src="${item.base64}" alt="History Image" class="history-preview-img w-full sm:w-24 h-auto sm:h-24 object-cover rounded-md mb-3 sm:mb-0 sm:mr-4 border border-slate-300 cursor-pointer">
                        <div class="flex-1">
                            <!-- (PERBAIKAN) Tata letak header kartu riwayat untuk menyertakan model -->
                            <div class="flex justify-between items-start mb-1 gap-2">
                                <p class="text-xs text-slate-500 whitespace-nowrap">${date} - ID: ${item.id.substring(0, 8)}</p>
                                <!-- (PERBAIKAN) Tampilkan nama model yang lebih baik dan nama lengkap di tooltip -->
                                <span class="text-[10px] font-semibold text-white bg-cyan-600 px-1.5 py-0.5 rounded-full capitalize flex-shrink-0" title="Model: ${modelName}">${displayModelName}</span>
                            </div>
                            <p class="font-medium text-slate-800 line-clamp-3" title="${item.prompt}">${item.prompt}</p>
                        </div>
                        <div class="flex sm:flex-col justify-end gap-2 mt-3 sm:mt-0 sm:ml-4">
                            <div class="relative group">
                            <button data-base64="${item.base64}" data-index="${item.id.substring(0, 8)}" class="history-download-btn p-2 rounded-full bg-green-500 hover:bg-green-600 text-white transition-colors">
                                    <i data-lucide="download" class="w-4 h-4"></i>
                                </button>
                                <span class="absolute z-10 bottom-full left-1/2 -translate-x-1/2 mb-2 p-1 px-2 text-xs font-medium text-white bg-slate-800 rounded opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none whitespace-nowrap">Unduh</span>
                            </div>
                            <div class="relative group">
                                <button class="history-copy-prompt-btn p-2 rounded-full bg-blue-50 hover:bg-blue-100 text-blue-700 transition-colors">
                                    <i data-lucide="copy" class="w-4 h-4"></i>
                                </button>
                                <span class="absolute z-10 bottom-full left-1/2 -translate-x-1/2 mb-2 p-1 px-2 text-xs font-medium text-white bg-slate-800 rounded opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none whitespace-nowrap">Salin Prompt</span>
                            </div>
                        </div>
                    `;
                    historyContainer.appendChild(historyCard);
                    historyCard.querySelector('.history-preview-img').addEventListener('click', (e) => openPreview(e.target.src));
                    historyCard.querySelector('.history-copy-prompt-btn').addEventListener('click', () => copyToClipboard(item.prompt));
                });
                historyContainer.querySelectorAll('.history-download-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const base64 = e.currentTarget.dataset.base64;
                        const id = e.currentTarget.dataset.index;
                        downloadBase64File(base64, `history_image_${id}.png`);
                        showMessage(`Gambar riwayat ${id} diunduh.`, 'success');
                    });
                });
                // Pastikan ikon Lucide dirender setelah elemen riwayat ditambahkan
                if (window.lucide && typeof lucide.createIcons === 'function') {
                    lucide.createIcons();
                }
            }

            async function switchView(view) {
                currentView = view;
                if (view === 'canvas') {
                    outputGrid.classList.remove('hidden');
                    historyContainer.classList.add('hidden');
                    canvasViewTitle.classList.add('border-b-3', 'border-blue-500', 'font-bold', 'text-slate-900');
                    canvasViewTitle.classList.remove('text-slate-400', 'hover:text-slate-600', 'font-medium');
                    historyViewTitle.classList.remove('border-b-3', 'border-blue-500', 'font-bold', 'text-slate-900');
                    historyViewTitle.classList.add('text-slate-400', 'hover:text-slate-600', 'font-medium');
                    // Periksa gambar yang valid
                    if (generatedImages.some(img => img && img.base64)) downloadBtn.classList.remove('hidden'); else downloadBtn.classList.add('hidden');
                    // Sembunyikan tombol hapus riwayat di Canvas
                    clearHistoryBtn.classList.add('hidden');
                
                } else { // 'history'
                    await renderHistory(); // Muat riwayat saat beralih
                    outputGrid.classList.add('hidden');
                    historyContainer.classList.remove('hidden');
                    historyViewTitle.classList.add('border-b-3', 'border-blue-500', 'font-bold', 'text-slate-900');
                    historyViewTitle.classList.remove('text-slate-400', 'hover:text-slate-600', 'font-medium');
                    canvasViewTitle.classList.remove('border-b-3', 'border-blue-500', 'font-bold', 'text-slate-900');
                    canvasViewTitle.classList.add('text-slate-400', 'hover:text-slate-600', 'font-medium');
                    downloadBtn.classList.add('hidden'); // Sembunyikan download zip di riwayat
                    clearHistoryBtn.classList.remove('hidden');
                }
            }

            function buildPreviewSequence() {
                previewSequence = [];
                for (let i = generatedImages.length - 1; i >= 0; i--) {
                    const gi = generatedImages[i];
                    if (gi && gi.base64) previewSequence.push({ source: 'generated', index: i });
                }
                for (let i = loadedHistory.length - 1; i >= 0; i--) {
                    const hi = loadedHistory[i];
                    if (hi && hi.base64) previewSequence.push({ source: 'history', index: i });
                }
            }

            function updatePreviewDisplay() {
                const total = previewSequence.length;
                if (total === 0) return;
                const item = previewSequence[previewIndexPos];
                let imageSrc = '';
                if (item.source === 'history') {
                    const current = loadedHistory[item.index];
                    if (current && current.base64) imageSrc = current.base64;
                } else {
                    const current = generatedImages[item.index];
                    if (current && current.base64) imageSrc = current.base64;
                }
                if (imageSrc) {
                    modalImage.src = imageSrc;
                    previewModal.dataset.currentImageUrl = imageSrc;
                }
                if (previewCounter) {
                    previewCounter.textContent = `${previewIndexPos + 1} / ${total}`;
                    previewCounter.classList.toggle('hidden', total <= 1);
                }
                if (previewPrevBtn && previewNextBtn) {
                    const hideControls = total <= 1;
                    previewPrevBtn.classList.toggle('hidden', hideControls);
                    previewNextBtn.classList.toggle('hidden', hideControls);
                }
                positionPreviewCounter();
            }

            function positionPreviewCounter() {
                if (!previewCounter) return;
                const panelVisible = editPanel && !editPanel.classList.contains('hidden');
                const defaultBottom = 12; // px
                if (panelVisible) {
                    const h = editPanel.offsetHeight || 0;
                    previewCounter.style.bottom = `${h + 12}px`;
                } else {
                    previewCounter.style.bottom = `${defaultBottom}px`;
                }
            }

            function showPrevPreview() {
                if (previewSequence.length <= 1) return;
                previewIndexPos = (previewIndexPos - 1 + previewSequence.length) % previewSequence.length;
                updatePreviewDisplay();
            }

            function showNextPreview() {
                if (previewSequence.length <= 1) return;
                previewIndexPos = (previewIndexPos + 1) % previewSequence.length;
                updatePreviewDisplay();
            }

            function onPreviewKeydown(e) {
                if (previewModal.classList.contains('hidden')) return;
                if (e.key === 'ArrowLeft') {
                    e.preventDefault();
                    showPrevPreview();
                } else if (e.key === 'ArrowRight') {
                    e.preventDefault();
                    showNextPreview();
                } else if (e.key === 'Escape') {
                    e.preventDefault();
                    closePreview();
                }
            }

            function onPreviewTouchStart(e) {
                const t = e.changedTouches && e.changedTouches[0];
                if (!t) return;
                previewTouchStartX = t.clientX;
                previewTouchStartY = t.clientY;
            }

            function onPreviewTouchEnd(e) {
                const t = e.changedTouches && e.changedTouches[0];
                if (!t || previewTouchStartX === null || previewTouchStartY === null) return;
                const dx = t.clientX - previewTouchStartX;
                const dy = t.clientY - previewTouchStartY;
                // Deteksi swipe horizontal dominan
                if (Math.abs(dx) > 30 && Math.abs(dx) > Math.abs(dy)) {
                    if (dx < 0) showNextPreview(); else showPrevPreview();
                }
                previewTouchStartX = null;
                previewTouchStartY = null;
            }

            function openPreview(imageUrl) {
                if (!imageUrl) return;
                buildPreviewSequence();
                let pos = 0;
                for (let j = 0; j < previewSequence.length; j++) {
                    const item = previewSequence[j];
                    if (item.source === 'history') {
                        const hi = loadedHistory[item.index];
                        if (hi && hi.base64 === imageUrl) { pos = j; break; }
                    } else {
                        const gi = generatedImages[item.index];
                        if (gi && gi.base64 === imageUrl) { pos = j; break; }
                    }
                }
                previewIndexPos = pos;
                previewModal.classList.remove('hidden');
                updatePreviewDisplay();

                // Wire controls
                if (previewPrevBtn) previewPrevBtn.onclick = showPrevPreview;
                if (previewNextBtn) previewNextBtn.onclick = showNextPreview;

                // Keyboard navigation
                previewKeydownHandler = onPreviewKeydown;
                document.addEventListener('keydown', previewKeydownHandler);

                // Swipe navigation on touch devices
                try {
                    modalImage.addEventListener('touchstart', onPreviewTouchStart, { passive: true });
                    modalImage.addEventListener('touchend', onPreviewTouchEnd, { passive: true });
                } catch (_) { /* no-op */ }
            }

            function closePreview() {
                previewModal.classList.add('hidden');
                modalImage.src = '';
                previewModal.dataset.currentImageUrl = '';
                if (editPanel) editPanel.classList.add('hidden');
                if (editLoading) editLoading.classList.add('hidden');
                // Bersihkan handlers
                if (previewKeydownHandler) {
                    document.removeEventListener('keydown', previewKeydownHandler);
                    previewKeydownHandler = null;
                }
                try {
                    modalImage.removeEventListener('touchstart', onPreviewTouchStart);
                    modalImage.removeEventListener('touchend', onPreviewTouchEnd);
                } catch (_) { /* no-op */ }
            }

            async function handleDownloadZip() {
                const validImages = generatedImages.filter(img => img && img.base64);
                if (validImages.length === 0) {
                    showMessage("Tidak ada gambar untuk diunduh.", 'info');
                    return;
                }
                showMessage("Membuat file ZIP...", 'info');
                try {
                    const zip = new JSZip();
                    validImages.forEach((img, index) => {
                        const base64Data = img.base64.split(',')[1];
                        zip.file(`image_${index + 1}.png`, base64Data, { base64: true });
                    });
                    const content = await zip.generateAsync({ type: "blob" });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(content);
                    link.download = `gemini_canvas_export_${new Date().getTime()}.zip`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(link.href);
                    showMessage(`Berhasil mengunduh ${validImages.length} gambar!`, 'success');
                } catch (error) {
                    console.error("Gagal membuat ZIP:", error);
                    showMessage("Gagal membuat file ZIP.", 'error');
                }
            }

            function getIntervalTime() {
                const type = listIntervalType.value;
                if (type === 'random') {
                    const min = parseInt(listIntervalMin.value, 10) || 1;
                    const max = parseInt(listIntervalMax.value, 10) || 5;
                    const finalMin = Math.min(min, max);
                    const finalMax = Math.max(min, max);
                    return Math.floor(Math.random() * (finalMax - finalMin + 1)) + finalMin;
                } else {
                    return parseInt(listIntervalTime.value, 10) || 5;
                }
            }
            
            // (PERBAIKAN) Fungsi upload gambar (untuk Referensi Gaya)
            function handleImageUpload(event, targetArray, previewContainer, clearButton) {
                const files = event.target.files;
                if (!files) return;
                
                const filesArr = Array.from(files);
                const limited = (targetArray === styleReferenceBase64s) ? filesArr.slice(0,1) : filesArr;
                limited.forEach(file => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const base64 = e.target.result.split(',')[1];
                        if (targetArray === styleReferenceBase64s) {
                            targetArray.length = 0; // hanya satu referensi style
                            targetArray.push(base64);
                        } else {
                            targetArray.push(base64);
                        }
                        updateImagePreview(targetArray, previewContainer, clearButton);
                        try {
                            const stylePopoverPreview = document.getElementById('style-popover-preview');
                            const clearStyleBtn = document.getElementById('clear-style-btn');
                            if (stylePopoverPreview) updateImagePreview(targetArray, stylePopoverPreview, clearStyleBtn || previewContainer);
                        } catch (_) {}
                        try { renderSettingsSummary(); } catch (_) {}
                        try { updateSubjectPreview(); } catch (_) {}
                    };
                    reader.readAsDataURL(file);
                });
                event.target.value = null; // Reset input
            }

            // (PERBAIKAN) Fungsi update preview (untuk Referensi Gaya)
            function updateImagePreview(targetArray, previewContainer, clearButton) {
                previewContainer.innerHTML = '';
                if (targetArray.length === 0) {
                    previewContainer.classList.add('hidden');
                    clearButton.classList.add('hidden');
                    return;
                }
                
                targetArray.forEach((base64, index) => {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'relative group w-16 h-16';
                    
                    const img = document.createElement('img');
                    img.src = `data:image/png;base64,${base64}`;
                    img.className = 'w-16 h-16 object-cover rounded-md border-2 border-cyan-300';
                    
                    const overlay = document.createElement('div');
                    overlay.className = 'absolute inset-0 bg-black/60 rounded-md flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity';
                    
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'p-1 text-white hover:text-red-400';
                    deleteBtn.innerHTML = '<i data-lucide="trash-2" class="w-4 h-4"></i>';
                    deleteBtn.title = 'Hapus';
                    deleteBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        targetArray.splice(index, 1);
                        updateImagePreview(targetArray, previewContainer, clearButton); // Render ulang
                    });
                    
                    overlay.appendChild(deleteBtn);
                    wrapper.appendChild(img);
                    wrapper.appendChild(overlay);
                    previewContainer.appendChild(wrapper);
                });
                
                previewContainer.classList.remove('hidden');
                clearButton.classList.remove('hidden');
                if (window.lucide && typeof lucide.createIcons === 'function') {
                    lucide.createIcons();
                }
            }

            // (PERBAIKAN) Fungsi clear (untuk Referensi Gaya)
            function clearImageReferences(targetArray, inputElement, previewContainer, clearButton) {
                targetArray.length = 0; // Kosongkan array
                if (inputElement) inputElement.value = null;
                updateImagePreview(targetArray, previewContainer, clearButton);
            }

            // === FUNGSI INTI ===
            // Util bantu: ekstrak ID file Google Drive dari berbagai format URL
            function extractDriveId(url) {
                if (!url) return '';
                try {
                    const u = new URL(url);
                    // Terima domain terkait Drive
                    const hostOk = ['drive.google.com', 'docs.google.com'].some(h => u.hostname.includes(h));
                    if (!hostOk) return '';
                    let id = u.searchParams.get('id');
                    if (id) return id;
                    // /file/d/<id>/view
                    const parts = u.pathname.split('/').filter(Boolean);
                    const dIdx = parts.indexOf('d');
                    if (dIdx !== -1 && parts[dIdx + 1]) return parts[dIdx + 1];
                    // /thumbnail?id=<id>
                    const thumbId = u.searchParams.get('id');
                    if (thumbId) return thumbId;
                    return '';
                } catch (_) {
                    return '';
                }
            }

            // Buat URL gambar Drive (view)
            function driveImageUrl(id) {
                return id ? `https://drive.google.com/uc?export=view&id=${id}` : '';
            }

            // Buat URL thumbnail Drive yang stabil
            function driveThumbUrl(id, size = 150) {
                return id ? `https://drive.google.com/thumbnail?id=${id}&sz=w${size}` : '';
            }

            // Normalisasi umum: jika URL dari Drive, gunakan uc?export=view; jika bukan, kembalikan apa adanya
            function normalizeDriveUrl(url) {
                const id = extractDriveId(url);
                return id ? driveImageUrl(id) : (url || '');
            }
            
            async function fetchAndRenderTemplates() {
                showMessage("Memuat template dari Google Sheet...", 'info');
                const csvUrl = DEFAULT_TEMPLATE_URL; 
                try {
                    const response = await fetch(csvUrl);
                    if (!response.ok) throw new Error(`Gagal mengambil CSV: ${response.statusText}`);
                    const csvText = await response.text();
                    const lines = csvText.trim().split('\n');
                    lines.shift(); 
                    
                    const templates = lines.map(line => {
                        const values = [];
                        let inQuote = false;
                        let field = '';
                        for (let i = 0; i < line.length; i++) {
                            const char = line[i];
                            if (char === '"') inQuote = !inQuote;
                            else if (char === ',' && !inQuote) { values.push(field.trim().replace(/^"|"$/g, '')); field = ''; }
                            else field += char;
                        }
                        values.push(field.trim().replace(/^"|"$/g, ''));

                        // Skema kolom: Kategori, Nama, Deskripsi, Prompt, Thumbnail (opsional)
                        if (values.length >= 3) {
                            if (values.length >= 5) {
                                return { category: values[0] || 'Lainnya', name: values[1], description: values[2], prompt: values[3], thumbnail: normalizeDriveUrl(values[4]) };
                            } else if (values.length >= 4) {
                                return { category: values[0] || 'Lainnya', name: values[1], description: values[2], prompt: values[3], thumbnail: '' };
                            } else {
                                return { category: 'Lainnya', name: values[0], description: values[1], prompt: values[2], thumbnail: '' };
                            }
                        }
                        return null;
                    }).filter(t => t && t.name && t.prompt);

                    fetchedTemplates = templates; 
                    showMessage(`Berhasil memuat ${templates.length} template.`, 'success');
                    renderTemplateButtons(templates, templateSearchInput ? (templateSearchInput.value || '') : '', templateCategoryFilter ? templateCategoryFilter.value : ''); 
                    updateCategoryFilterOptions(templates);
                    updateSelectedTemplateCount();
                } catch (error) {
                    console.error("Gagal memuat template:", error);
                    showMessage("Gagal memuat template. Menggunakan daftar kosong.", 'error');
                    fetchedTemplates = [];
                    renderTemplateButtons([]);
                    updateCategoryFilterOptions([]);
                }
            }

            async function fetchListPrompts() {
                showMessage("Memuat daftar prompt dari Google Sheet...", 'info');
                const csvUrl = listSheetUrlInput.value || DEFAULT_LIST_EXAMPLE_URL;
                if (!csvUrl) {
                    showMessage("URL Google Sheet untuk Mode List belum diatur.", 'error');
                    listTotalCount.textContent = 0;
                    fetchedListPrompts = [];
                    return;
                }

                try {
                    const response = await fetch(csvUrl);
                    if (!response.ok) throw new Error(`Gagal mengambil CSV: ${response.statusText}`);
                    const csvText = await response.text();
                    const lines = csvText.trim().split('\n');
                    lines.shift(); // Hapus header

                    const prompts = lines.map(line => {
                        const values = [];
                        let inQuote = false;
                        let field = '';
                        for (let i = 0; i < line.length; i++) {
                            const char = line[i];
                            if (char === '"') inQuote = !inQuote;
                            else if (char === ',' && !inQuote) { values.push(field.trim().replace(/^"|"$/g, '')); field = ''; }
                            else field += char;
                        }
                        values.push(field.trim().replace(/^"|"$/g, ''));
                        
                        // (DIMODIFIKASI) Ambil hanya kolom pertama
                        if (values.length >= 1 && values[0]) {
                            const promptText = values[0];
                            return { 
                                category: "Daftar", 
                                name: promptText.substring(0, 50) + (promptText.length > 50 ? "..." : ""), 
                                description: "Prompt dari Google Sheet 1-kolom.", 
                                prompt: promptText 
                            };
                        }
                        return null;
                    }).filter(t => t && t.name && t.prompt); 

                    fetchedListPrompts = prompts; 
                    showMessage(`Berhasil memuat ${prompts.length} prompt untuk batch.`, 'success');
                    listTotalCount.textContent = prompts.length; 
                    try { updateCommandBarListCountInfo(); } catch (_) {}
                } catch (error) {
                    console.error("Gagal memuat daftar prompt:", error);
                    showMessage("Gagal memuat daftar prompt. Periksa URL.", 'error');
                    fetchedListPrompts = [];
                    listTotalCount.textContent = 0;
                    try { updateCommandBarListCountInfo(); } catch (_) {}
                }
            }

            async function optimizePrompt(userPrompt) {
                const systemPrompt = `You are a creative prompt optimizer for an AI image generator. 
                Your task is to take a user's prompt and rewrite it to be more descriptive, vivid, and evocative. 
                Do NOT change the core subject or meaning. 
                Add details about lighting, style, and composition.
                Respond ONLY with the new, optimized prompt.`;
                const payload = {
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                    contents: [{ parts: [{ text: userPrompt }] }],
                };
                const result = await fetchWithRetry(API_URL_TEXT_GEN, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (result && result.candidates?.[0]?.content?.parts?.[0]?.text) {
                    return result.candidates[0].content.parts[0].text.trim();
                } else {
                    console.warn("Optimasi prompt gagal, menggunakan prompt asli.");
                    return userPrompt;
                }
            }

            async function generateImage(finalPrompt, aspectRatio, subjectRefs, styleRefs) {
                const hasRefs = subjectRefs.length > 0 || styleRefs.length > 0;
                const useMultimodal = preferredModel === 'gemini' ? true : preferredModel === 'imagen' ? false : hasRefs;
                let apiUrl, payload;
                let modelName; // (BARU)

                if (useMultimodal) {
                    apiUrl = API_URL_IMAGE_EDIT;
                    modelName = "gemini-2.5-flash-image-preview"; // (PERBAIKAN) Gunakan nama lengkap
                    let parts = [];
                    // (PERUBAHAN) Instruksi prompt dibuat lebih kuat untuk memaksa rasio aspek
                    const forcedAspectRatio = aspectRatio || '1:1';
                    const promptInstruction = `GENERATE an image of: [${finalPrompt}]
                    IMPORTANTLY: The final image MUST strictly follow the aspect ratio: ${forcedAspectRatio}.
                    This aspect ratio instruction (${forcedAspectRatio}) is the highest priority.
                    You MUST generate the image to fit ${forcedAspectRatio}, even if it means cropping or adjusting the composition from the reference images.`;
                    
                    parts.push({ text: promptInstruction });
                    
                    subjectRefs.forEach(base64Data => {
                        parts.push({ text: "Use this image as the main SUBJECT reference:" });
                        parts.push({ inlineData: { mimeType: "image/png", data: base64Data } });
                    });
                    styleRefs.forEach(base64Data => {
                        parts.push({ text: "Gunakan gambar berikut sebagai referensi gaya:" });
                        parts.push({ inlineData: { mimeType: "image/png", data: base64Data } });
                    });
                    payload = {
                        contents: [{ parts: parts }],
                        generationConfig: { responseModalities: ['TEXT', 'IMAGE'] },
                    };
                } else {
                    apiUrl = API_URL_IMAGE_GEN;
                    modelName = "imagen-4.0-generate-001"; // (PERBAIKAN) Gunakan nama lengkap
                    payload = {
                        instances: [{ prompt: finalPrompt }],
                        parameters: { sampleCount: 1, aspectRatio: aspectRatio }
                    };
                }
                const result = await fetchWithRetry(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                
                let base64String = null; // (BARU)
                
                if (useMultimodal) {
                    const base64Data = result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;
                    if (!base64Data) console.error("API Multimodal Error:", result); 
                    base64String = base64Data ? `data:image/png;base64,${base64Data}` : null; // (MODIFIKASI)
                } else {
                    const base64Data = result?.predictions?.[0]?.bytesBase64Encoded;
                    if (!base64Data) console.error("API Imagen Error:", result); 
                    base64String = base64Data ? `data:image/png;base64,${base64Data}` : null; // (MODIFIKASI)
                }
                
                return { base64: base64String, model: modelName }; // (MODIFIKASI) Kembalikan objek
            }


            function renderTemplateButtons(templates, query = '', categoryFilter = '') {
                if (!templateButtonsContainer) return; // (PERBAIKAN) Tambahkan penjaga
                templateButtonsContainer.innerHTML = '';
                const normalizedQuery = (query || '').trim().toLowerCase();
                let sourceTemplates = normalizedQuery
                    ? templates.filter(t => {
                        const fields = [t.name, t.description, t.category, t.prompt].filter(Boolean).map(v => v.toLowerCase());
                        return fields.some(v => v.includes(normalizedQuery));
                    })
                    : templates;
                if (categoryFilter && categoryFilter.trim() !== '') {
                    sourceTemplates = sourceTemplates.filter(t => (t.category || 'Lainnya') === categoryFilter);
                }

                const groupedTemplates = sourceTemplates.reduce((acc, template) => {
                    const category = template.category || 'Lainnya';
                    if (!acc[category]) acc[category] = [];
                    acc[category].push(template);
                    return acc;
                }, {});
                for (const category in groupedTemplates) {
                    const header = document.createElement('h3');
                    // (DIMODIFIKASI) Tambahkan kelas untuk klik kategori
                    header.className = 'text-xs font-semibold text-slate-500 uppercase tracking-wide col-span-2 sm:col-span-3 lg:col-span-4 mt-4 first:mt-0 cursor-pointer hover:text-blue-600';
                    header.textContent = category;
                    header.dataset.category = category; // (BARU) Tambahkan data-category
                    header.addEventListener('click', handleCategoryClick); // (BARU) Tambahkan event listener
                    templateButtonsContainer.appendChild(header);

                    groupedTemplates[category].forEach((template) => {
                        const button = document.createElement('button');
                        const placeholderText = encodeURIComponent((template.name || 'T').slice(0, 10));
                        let thumbUrl = '';
                        if (template.thumbnail && template.thumbnail.trim()) {
                            const id = extractDriveId(template.thumbnail.trim());
                            // Pilih ukuran thumbnail sesuai mode
                            const size = templateViewMode === 'list' ? 64 : 150;
                            thumbUrl = id ? driveThumbUrl(id, size) : normalizeDriveUrl(template.thumbnail.trim());
                        } else {
                            thumbUrl = templateViewMode === 'list'
                                ? `https://placehold.co/64x64/93c5fd/ffffff?text=${placeholderText}`
                                : `https://placehold.co/150x150/93c5fd/ffffff?text=${placeholderText}`;
                        }

                        if (templateViewMode === 'list') {
                            // Mode list: kecil + nama
                            button.className = 'template-btn flex items-center gap-3 p-2 rounded-xl bg-white hover:bg-slate-50 border border-slate-200 ring-2 ring-transparent transition-colors';
                            const thumb = document.createElement('img');
                            thumb.src = thumbUrl;
                            thumb.referrerPolicy = 'no-referrer';
                            thumb.alt = template.name || 'Template';
                            thumb.className = 'w-9 h-9 object-cover rounded-md border border-slate-300';
                            
                            // (PERBAIKAN) Fallback jika thumbnail gagal
                            thumb.onerror = (e) => {
                                const placeholderUrl = `https://placehold.co/64x64/93c5fd/ffffff?text=${placeholderText}`;
                                if (e.target.src !== placeholderUrl) {
                                    e.target.src = placeholderUrl;
                                } else {
                                    e.target.style.display = 'none'; // Sembunyikan gambar rusak
                                    const icon = document.createElement('div');
                                    icon.className = 'w-9 h-9 rounded-md border border-slate-300 bg-slate-100 flex items-center justify-center';
                                    icon.innerHTML = `<i data-lucide="image" class="w-4 h-4 text-slate-400"></i>`;
                                    button.prepend(icon);
                                    if (window.lucide && typeof lucide.createIcons === 'function') {
                                        lucide.createIcons();
                                    }
                                }
                            };
                            
                            const title = document.createElement('span');
                            title.className = 'text-sm font-medium text-slate-800 truncate';
                            title.textContent = template.name || 'Template';
                            button.appendChild(thumb);
                            button.appendChild(title);
                        } else {
                            // Mode grid: thumbnail-only 150x150
                            button.className = 'template-btn p-2 rounded-md bg-white hover:bg-slate-50 border border-slate-200 ring-2 ring-transparent transition-colors';
                            const thumb = document.createElement('img');
                            thumb.src = thumbUrl;
                            thumb.referrerPolicy = 'no-referrer';
                            thumb.alt = template.name || 'Template';
                            thumb.className = 'w-[150px] h-[150px] object-cover rounded-sm';
                            
                            // (PERBAIKAN) Fallback jika thumbnail gagal
                            thumb.onerror = (e) => {
                                const placeholderUrl = `https://placehold.co/150x150/93c5fd/ffffff?text=${placeholderText}`;
                                 if (e.target.src !== placeholderUrl) {
                                    e.target.src = placeholderUrl;
                                } else {
                                    e.target.style.display = 'none'; // Sembunyikan gambar rusak
                                    const icon = document.createElement('div');
                                    icon.className = 'w-[150px] h-[150px] rounded-sm bg-slate-100 flex items-center justify-center';
                                    icon.innerHTML = `<i data-lucide="image" class="w-10 h-10 text-slate-400"></i>`;
                                    button.prepend(icon);
                                    if (window.lucide && typeof lucide.createIcons === 'function') {
                                        lucide.createIcons();
                                    }
                                }
                            };
                            
                            button.appendChild(thumb);
                        }

                        button.dataset.prompt = template.prompt;
                        button.dataset.name = template.name; 
                        button.dataset.category = category; // (BARU) Tambahkan data-category
                        button.addEventListener('click', handleTemplateClick);
                        button.addEventListener('mouseover', () => updateTemplatePreview(template));

                        // Pertahankan state terpilih saat re-render
                        if (selectedTemplatePrompts.includes(template.prompt)) {
                            button.classList.add('ring-blue-500');
                            button.classList.remove('ring-transparent');
                            button.classList.remove('border-slate-200');
                            button.classList.add('border-blue-400');
                        }
                        templateButtonsContainer.appendChild(button);
                    });
                }
                if (sourceTemplates.length === 0) {
                     templateButtonsContainer.innerHTML = '<p class="text-xs text-slate-500 col-span-2">Tidak ada template yang dapat dimuat.</p>';
                }

                if (templateTotalInfo) templateTotalInfo.textContent = `Total: ${sourceTemplates.length} template`;

                // Render ikon lucide bila ada di panel
                if (window.lucide && typeof lucide.createIcons === 'function') {
                    lucide.createIcons();
                }

                applyTemplateViewMode();
            }

            function updateTemplatePreview(template) {
                if (!template) return;
                const placeholderText = encodeURIComponent((template.name || 'Template').slice(0, 20));
                let previewUrl = '';
                if (template.thumbnail && template.thumbnail.trim()) {
                    const id = extractDriveId(template.thumbnail.trim());
                    // Pakai thumbnail yang lebih besar agar cepat dan stabil
                    previewUrl = id ? driveThumbUrl(id, 480) : normalizeDriveUrl(template.thumbnail.trim());
                } else {
                    previewUrl = `https://placehold.co/480x320/64748b/ffffff?text=${placeholderText}`;
                }
                if (templatePreviewImage) {
                    templatePreviewImage.referrerPolicy = 'no-referrer';
                    templatePreviewImage.src = previewUrl;
                    templatePreviewImage.onerror = (e) => {
                         e.target.src = `https://placehold.co/480x320/64748b/ffffff?text=Preview+Gagal`;
                    };
                }
                if (templatePreviewTitle) templatePreviewTitle.textContent = template.name || 'Template';
                if (templatePreviewDesc) templatePreviewDesc.textContent = template.description || '';
                if (templatePreviewPrompt) templatePreviewPrompt.textContent = template.prompt || '';
            }

            function updateCategoryFilterOptions(templates) {
                if (!templateCategoryFilter) return;
                const categories = Array.from(new Set((templates || []).map(t => t.category || 'Lainnya'))).sort();
                // Reset, keep 'Semua Kategori'
                templateCategoryFilter.innerHTML = '<option value="">Semua Kategori</option>' + categories.map(c => `<option value="${c}">${c}</option>`).join('');
            }

            function renderSelectedTemplatesList() {
                if (!selectedTemplatesContainer) return;
                selectedTemplatesContainer.innerHTML = '';
                const selected = fetchedTemplates.filter(t => selectedTemplatePrompts.includes(t.prompt));
                selected.forEach(t => {
                    const item = document.createElement('div');
                    item.className = 'flex items-center justify-between gap-2 p-2 border border-slate-200 rounded-md bg-white';
                    const title = document.createElement('div');
                    title.className = 'text-xs font-semibold text-slate-800 truncate';
                    title.textContent = t.name || 'Template';
                    title.title = t.name || 'Template'; // (PERBAIKAN) Menambahkan tooltip
                    const removeBtn = document.createElement('button');
                    removeBtn.className = 'p-1 rounded-md bg-slate-100 hover:bg-slate-200';
                    removeBtn.innerHTML = '<i data-lucide="x" class="w-3 h-3"></i>';
                    removeBtn.title = 'Hapus dari pilihan';
                    removeBtn.addEventListener('click', () => {
                        const idx = selectedTemplatePrompts.indexOf(t.prompt);
                        if (idx > -1) {
                            selectedTemplatePrompts.splice(idx, 1);
                            // sinkronkan state tombol di modal
                            const btn = document.querySelector(`.template-btn[data-prompt="${CSS.escape(t.prompt)}"]`);
                            if (btn) {
                                btn.classList.remove('ring-blue-500');
                                btn.classList.add('ring-transparent');
                                btn.classList.remove('border-blue-400');
                                btn.classList.add('border-slate-200');
                            }
                            renderSelectedTemplatesList();
                            updateSelectedTemplateCount();
                            try { renderTemplateChips(); } catch(_) {}
                        }
                    });
                    item.appendChild(title);
                    item.appendChild(removeBtn);
                    selectedTemplatesContainer.appendChild(item);
                });
                // update icons
                if (window.lucide && typeof lucide.createIcons === 'function') {
                    lucide.createIcons();
                }
            }

            function updateSelectedTemplateCount() {
                const count = selectedTemplatePrompts.length;
                if (selectedTemplatesCount) selectedTemplatesCount.textContent = `${count} template dipilih`;
                if (templateSelectedInfo) templateSelectedInfo.textContent = `Dipilih: ${count} template`;
            }

            function openTemplateModal() {
                if (templateModal) templateModal.classList.remove('hidden');
            }
            function closeTemplateModal() {
                if (templateModal) templateModal.classList.add('hidden');
            }

            function applyTemplateViewMode() {
                if (!templateButtonsContainer) return;
                if (templateViewMode === 'grid') {
                    templateButtonsContainer.className = 'grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4';
                    if (templateViewToggle) templateViewToggle.innerHTML = '<i data-lucide="layout-grid" class="w-4 h-4"></i>';
                } else {
                    templateButtonsContainer.className = 'flex flex-col gap-2';
                    if (templateViewToggle) templateViewToggle.innerHTML = '<i data-lucide="list" class="w-4 h-4"></i>';
                }
                if (window.lucide && typeof lucide.createIcons === 'function') {
                    lucide.createIcons();
                }
            }

            // Util: append teks dengan highlight tanpa innerHTML berbahaya
            function appendHighlighted(container, text, query) {
                const safeText = String(text || '');
                if (!query) {
                    container.textContent = safeText;
                    return;
                }
                const lower = safeText.toLowerCase();
                const idx = lower.indexOf(query);
                if (idx === -1) {
                    container.textContent = safeText;
                    return;
                }
                const before = safeText.slice(0, idx);
                const match = safeText.slice(idx, idx + query.length);
                const after = safeText.slice(idx + query.length);
                if (before) container.appendChild(document.createTextNode(before));
                const mark = document.createElement('mark');
                mark.className = 'bg-yellow-200 rounded px-1';
                mark.textContent = match;
                container.appendChild(mark);
                if (after) container.appendChild(document.createTextNode(after));
            }

            // Util: hanya fokus di desktop untuk mencegah keyboard muncul di mobile
            function safeFocus(el) {
                try {
                    if (!el) return;
                    const isTouch = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);
                    const isFinePointer = window.matchMedia && window.matchMedia('(pointer: fine)').matches;
                    if (isTouch || !isFinePointer) return; // jangan fokus di perangkat sentuh/coarse pointer
                    el.focus();
                } catch (_) { /* no-op */ }
            }

            // Scroll independen: cegah bubbling antar container
            function setupIndependentScroll(el) {
                if (!el) return;
                try {
                    // CSS sudah overscroll-contain; tambah pencegahan event bubbling
                    el.addEventListener('wheel', (e) => e.stopPropagation(), { passive: true });
                    if (!el.id || !el.id.startsWith('crop-left')) {
                        el.addEventListener('touchmove', (e) => e.stopPropagation(), { passive: true });
                    }
                } catch (_) { /* no-op */ }
            }

            async function updateCard(card, finalPrompt, base64, model) { // (MODIFIKASI) Tambahkan 'model'
                const spinner = card.querySelector('.spinner');
                const loadingOverlay = card.querySelector('.loading-overlay');
                const img = card.querySelector('img');
                const downloadBtnEl = card.querySelector('.download-single-btn'); 
                const regenerateBtn = card.querySelector('.regenerate-btn');
                const copyBtn = card.querySelector('.copy-prompt-btn');
                const promptEl = card.querySelector('.card-prompt');

                if (base64) {
                    img.src = base64;
                    img.classList.remove('hidden');
                    spinner.classList.add('hidden');
                    if (loadingOverlay) loadingOverlay.classList.add('hidden');
                    downloadBtnEl.disabled = false;
                    
                    const index = parseInt(card.dataset.index, 10);
                    // Pastikan generatedImages[index] ada
                    if (index < generatedImages.length) {
                        generatedImages[index] = { base64: base64, prompt: finalPrompt, model: model }; // (MODIFIKASI)
                    } else {
                        // Ini seharusnya tidak terjadi jika placeholder dibuat dengan benar
                        generatedImages.push({ base64: base64, prompt: finalPrompt, model: model }); // (MODIFIKASI)
                    }
                    card.dataset.base64 = base64; 
                    card.dataset.model = model; // (BARU) Simpan di kartu juga
                    
                    if (currentView === 'canvas' && generatedImages.some(img => img && img.base64)) {
                        downloadBtn.classList.remove('hidden'); 
                    }
                    updateCommandBarContrast();

                    try {
                        const historyItem = {
                            id: `img_${new Date().getTime()}_${index}`,
                            prompt: finalPrompt,
                            base64: base64,
                            timestamp: new Date().getTime(),
                            model: model // (MODIFIKASI) Tambahkan model ke objek riwayat
                        };
                        const shouldSaveHistory = !(currentMode === 'list' && listDisableHistory && listDisableHistory.checked);
                        if (shouldSaveHistory) {
                            await saveImageToHistory(historyItem);
                        }
                    } catch (err) {
                        console.error("Gagal menyimpan ke riwayat:", err);
                        showMessage("Gagal menyimpan ke riwayat.", "error");
                    }
                    
                    if (currentMode === 'list' && listAutoDownload.checked) {
                        downloadBase64File(base64, `list_image_${currentBatchIndex + 1}_${index + 1}.png`);
                    }

                } else {
                    img.src = 'https://placehold.co/512x512/f87171/ffffff?text=Gagal';
                    img.classList.remove('hidden');
                    spinner.classList.add('hidden');
                    if (loadingOverlay) loadingOverlay.classList.add('hidden');
                    showMessage("Gagal menghasilkan gambar.", 'error');
                }

                promptEl.textContent = finalPrompt;
                promptEl.title = finalPrompt;
                card.dataset.prompt = finalPrompt; 
                regenerateBtn.disabled = false;
                copyBtn.disabled = false;
            }

            async function processSinglePrompt(originalPrompt, imageCount, aspectRatio, subjectRefs, styleRefs) {
                const optimizerSelect = document.getElementById('select-optimizer');
                const useOptimizer = optimizerSelect.value === 'image';
                
                // (DIHAPUS) Pembersihan grid dipindahkan ke handleGenerateClick
                // outputGrid.innerHTML = ''; 
                // generatedImages = new Array(imageCount).fill(null);
                // downloadBtn.classList.add('hidden');

                let prompts = new Array(imageCount).fill(originalPrompt);

                if (useOptimizer) {
                    const optimizedPrompts = await Promise.allSettled(
                        prompts.map(p => optimizePrompt(p))
                    );
                    prompts = optimizedPrompts.map((result, i) => 
                        result.status === 'fulfilled' ? result.value : prompts[i]
                    );
                }
                

                    const placeholderCards = [];
                    for (let i = 0; i < prompts.length; i++) {
                        const idx = generatedImages.length;
                        generatedImages.push(null);
                        const card = createPlaceholderCard(useOptimizer ? 'Mengoptimasi...' : originalPrompt, idx);
                        prependCardWithDate(card);
                        placeholderCards.push({ card, prompt: prompts[i] });
                    }

                    // Render ikon Lucide untuk kartu yang baru ditambahkan
                    if (window.lucide && typeof lucide.createIcons === 'function') {
                        lucide.createIcons();
                    }

                await Promise.allSettled(placeholderCards.map(async ({ card, prompt }) => {
                    // Log penggunaan prompt (mode single)
                    logPromptToSupabase('single', prompt);
                    try {
                        const { base64, model } = await generateImage(prompt, aspectRatio, subjectRefs, styleRefs); // (MODIFIKASI)
                        if (!base64) throw new Error("API tidak mengembalikan gambar.");
                        await updateCard(card, prompt, base64, model); // (MODIFIKASI)
                    } catch (error) {
                        console.error("Gagal memproses prompt:", error);
                        await updateCard(card, prompt, null, null); // (MODIFIKASI)
                    }
                }));
            }

            async function handleRegenerate(card) {
                const originalPrompt = card.dataset.prompt;
                if (!originalPrompt) return;

                const spinner = card.querySelector('.spinner');
                const loadingOverlay = card.querySelector('.loading-overlay');
                const img = card.querySelector('img');
                const downloadBtnEl = card.querySelector('.download-single-btn');
                const regenerateBtn = card.querySelector('.regenerate-btn');
                const copyBtn = card.querySelector('.copy-prompt-btn');

                img.classList.add('hidden');
                spinner.classList.remove('hidden');
                if (loadingOverlay) loadingOverlay.classList.remove('hidden');
                downloadBtnEl.disabled = true;
                regenerateBtn.disabled = true;
                copyBtn.disabled = true;

                const aspectRatio = document.getElementById('select-aspect-ratio').value;
                const optimizerSelect = document.getElementById('select-optimizer');
                
                // (PERBAIKAN) Cek visibilitas kontainer optimasi
                const useOptimizer = !optimizerContainer.classList.contains('hidden') && optimizerSelect.value === 'image';

                let finalPrompt = originalPrompt;
                if (useOptimizer) {
                    finalPrompt = await optimizePrompt(originalPrompt);
                }

                try {
                    // Log penggunaan prompt saat regenerate memakai mode terpilih sekarang
                    const currentModeValue = document.querySelector('input[name="mode"]:checked')?.value || 'unknown';
                    logPromptToSupabase(currentModeValue, finalPrompt);
                    const { base64, model } = await generateImage(finalPrompt, aspectRatio, subjectReferenceBase64s, styleReferenceBase64s); // (MODIFIKASI)
                    if (!base64) throw new Error("API tidak mengembalikan gambar.");
                    await updateCard(card, finalPrompt, base64, model); // (MODIFIKASI)
                } catch (error) {
                    console.error("Gagal regenerate:", error);
                    await updateCard(card, finalPrompt, null, null); // (MODIFIKASI)
                }
            }
            
            // (BARU) Fungsi untuk menangani klik kategori (multi-select)
            function handleCategoryClick(e) {
                const category = e.currentTarget.dataset.category;
                const buttons = document.querySelectorAll(`.template-btn[data-category="${category}"]`);
                if (buttons.length === 0) return;

                // Cek apakah semua sudah terpilih
                const allSelected = Array.from(buttons).every(btn => selectedTemplatePrompts.includes(btn.dataset.prompt));

                buttons.forEach(btn => {
                    const prompt = btn.dataset.prompt;
                    const index = selectedTemplatePrompts.indexOf(prompt);

                    if (allSelected) {
                        // Batal pilih semua
                        if (index > -1) {
                            selectedTemplatePrompts.splice(index, 1);
                        }
                        btn.classList.remove('ring-blue-500');
                        btn.classList.add('ring-transparent');
                        btn.classList.remove('border-blue-400');
                        btn.classList.add('border-slate-200');
                    } else {
                        // Pilih semua
                        if (index === -1) {
                            selectedTemplatePrompts.push(prompt);
                        }
                        btn.classList.add('ring-blue-500');
                        btn.classList.remove('ring-transparent');
                        btn.classList.remove('border-slate-200');
                        btn.classList.add('border-blue-400');
                    }
                });

                const message = allSelected ? `Membatalkan pilihan Kategori "${category}".` : `Memilih semua Kategori "${category}".`;
                showMessage(message, 'info');
                safeFocus(inputs.template || inputs.single);
                renderSelectedTemplatesList();
                updateSelectedTemplateCount();
                try { renderTemplateChips(); } catch(_) {}
            }

            // (DIMODIFIKASI) Fungsi-fungsi untuk Mode List
            async function startBatchGeneration() {
                if (fetchedListPrompts.length === 0) {
                    showMessage("Tidak ada prompt dalam daftar. Sinkronkan terlebih dahulu.", 'error');
                    return;
                }
                isBatchRunning = true;
                currentBatchIndex = 0;
                // Reset dan baca batas pengulangan
                listRepeatCounter = 0;
                listRepeatLimit = parseInt(listRepeatCountInput?.value, 10) || 0; // 0 = unlimited
                generateBtnText.textContent = 'Hentikan Batch';
                generateBtn.classList.remove('from-blue-500', 'to-blue-600', 'hover:from-blue-600', 'hover:to-blue-700');
                generateBtn.classList.add('from-red-500', 'to-red-600', 'hover:from-red-600', 'hover:to-red-700');
                modeRadios.forEach(radio => radio.disabled = true);
                try {
                    const running = document.getElementById('cb-running-body');
                    const textareaBody = document.getElementById('cb-textarea-body');
                    if (running && textareaBody) { running.classList.remove('hidden'); textareaBody.classList.add('hidden'); }
                } catch (_) {}
                try { syncCommandGenerateBtn(); } catch (_) {}
                if (currentView !== 'canvas') {
                    await switchView('canvas');
                }
                try { adjustCanvasLayout(); } catch (_) {}
                outputGrid.innerHTML = ''; 
                generatedImages = []; 
                downloadBtn.classList.add('hidden');
                
                // (BARU) Mulai Timer Total
                batchStartTime = Date.now();
                listTotalTime.textContent = '00:00:00';
                listCountdownTime.textContent = 'Memulai...';
                if (batchTotalTimerId) clearInterval(batchTotalTimerId);
                batchTotalTimerId = setInterval(() => {
                    const elapsedSeconds = Math.floor((Date.now() - batchStartTime) / 1000);
                    const t = formatTime(elapsedSeconds);
                    listTotalTime.textContent = t;
                    updateCommandBarTimers(document.getElementById('list-countdown-time')?.textContent || '', `Total: ${t}`);
                }, 1000);

                runBatchTask();
            }

            function stopBatchGeneration() {
                isBatchRunning = false;
                if (batchTimeoutId) {
                    clearTimeout(batchTimeoutId);
                    batchTimeoutId = null;
                }
                // (BARU) Hentikan semua timer
                if (batchTotalTimerId) {
                    clearInterval(batchTotalTimerId);
                    batchTotalTimerId = null;
                }
                if (batchCountdownTimerId) {
                    clearInterval(batchCountdownTimerId);
                    batchCountdownTimerId = null;
                }

                generateBtnText.textContent = 'Mulai Batch';
                generateBtn.classList.add('from-blue-500', 'to-blue-600', 'hover:from-blue-600', 'hover:to-blue-700');
                generateBtn.classList.remove('from-red-500', 'to-red-600', 'hover:from-red-600', 'hover:to-red-700');
                modeRadios.forEach(radio => radio.disabled = false);
                listCurrentPrompt.textContent = 'Dihentikan';
                listCountdownTime.textContent = '--'; // (BARU) Reset countdown
                showMessage("Batch dihentikan.", 'info');
                try {
                    const running = document.getElementById('cb-running-body');
                    const textareaBody = document.getElementById('cb-textarea-body');
                    if (running && textareaBody) { running.classList.add('hidden'); textareaBody.classList.remove('hidden'); }
                } catch (_) {}
                try { syncCommandGenerateBtn(); } catch (_) {}
                try { adjustCanvasLayout(); } catch (_) {}
            }

            // (DIMODIFIKASI) Logika inti batch dengan timer
            async function runBatchTask() {
                if (!isBatchRunning) return; // Keluar jika dihentikan

                // Ambil tugas
                const task = fetchedListPrompts[currentBatchIndex];
                const originalPrompt = task.prompt;
                listCurrentPrompt.textContent = `${currentBatchIndex + 1}/${fetchedListPrompts.length}: ${task.name}`;
                
                try {
                    const runTxt = document.getElementById('running-prompt-text');
                    if (runTxt) runTxt.textContent = `${currentBatchIndex + 1}/${fetchedListPrompts.length}: ${task.name}`;
                } catch (_) {}

                const imageCount = parseInt(document.getElementById('image-count').value, 10) || 1;
                const aspectRatio = document.getElementById('select-aspect-ratio').value;
                
                const batchPlaceholders = [];
                for (let i = 0; i < imageCount; i++) {
                    // (PERBAIKAN) Gunakan generatedImages.length untuk index
                    const card = createPlaceholderCard(originalPrompt, generatedImages.length); 
                    outputGrid.prepend(card); 
                    generatedImages.push(null); 
                    batchPlaceholders.push(card);
                }

                // Render ikon Lucide untuk kartu batch yang baru ditambahkan
                if (window.lucide && typeof lucide.createIcons === 'function') {
                    lucide.createIcons();
                }

                // Proses semua gambar untuk prompt ini
                await Promise.allSettled(batchPlaceholders.map(async (card) => {
                    // Log penggunaan prompt (mode list)
                    logPromptToSupabase('list', originalPrompt);
                    try {
                        const { base64, model } = await generateImage(originalPrompt, aspectRatio, [], styleReferenceBase64s); // (MODIFIKASI) 
                        if (!base64) throw new Error("API tidak mengembalikan gambar.");
                        await updateCard(card, originalPrompt, base64, model); // (MODIFIKASI)
                    } catch (error) {
                        console.error("Gagal memproses prompt list:", error);
                        await updateCard(card, originalPrompt, null, null); // (MODIFIKASI)
                    }
                }));

                // Pindah ke prompt berikutnya
                currentBatchIndex++;
                
                // Cek apakah batch selesai atau perlu diulang
                if (currentBatchIndex >= fetchedListPrompts.length) {
                    if (listRepeat.checked) {
                        // Hitung pengulangan; 0 = unlimited
                        if (listRepeatLimit > 0) {
                            listRepeatCounter += 1;
                            if (listRepeatCounter >= listRepeatLimit) {
                                showMessage(`Batch selesai sesuai jumlah pengulangan (${listRepeatLimit}).`, 'success');
                                stopBatchGeneration();
                                return;
                            } else {
                                showMessage(`Batch selesai. Mengulang ke awal (${listRepeatCounter}/${listRepeatLimit}).`, 'info');
                            }
                        } else {
                            showMessage("Batch selesai. Mengulang tanpa batas...", 'info');
                        }

                        currentBatchIndex = 0;

                        // (BARU) Logika Sinkronisasi Otomatis
                        if (listAutoSync.checked) {
                            showMessage("Sinkronisasi otomatis: Memuat data baru dari G-Sheet...", 'info');
                            await fetchListPrompts(); // Muat ulang data
                            if (fetchedListPrompts.length === 0) {
                                showMessage("Sinkronisasi otomatis gagal atau daftar kosong. Menghentikan batch.", 'error');
                                stopBatchGeneration();
                                return;
                            }
                        }
                    } else {
                        showMessage("Batch selesai!", 'success');
                        stopBatchGeneration();
                        return; // Keluar dari fungsi
                    }
                }
                
                // (BARU) Logika Countdown dan Penjadwalan
                if (batchTimeoutId) clearTimeout(batchTimeoutId);
                if (batchCountdownTimerId) clearInterval(batchCountdownTimerId);
                
                const intervalSeconds = getIntervalTime();
                batchNextRunTime = Date.now() + intervalSeconds * 1000;

                // Mulai timer countdown
                let secondsRemaining = intervalSeconds;
                listCountdownTime.textContent = `${secondsRemaining} detik`;
                updateCommandBarTimers(`${secondsRemaining} detik`, document.getElementById('list-total-time')?.textContent ? `Total: ${document.getElementById('list-total-time').textContent}` : '');
                
                batchCountdownTimerId = setInterval(() => {
                    secondsRemaining--;
                    listCountdownTime.textContent = `${secondsRemaining} detik`;
                    updateCommandBarTimers(`${secondsRemaining} detik`, document.getElementById('list-total-time')?.textContent ? `Total: ${document.getElementById('list-total-time').textContent}` : '');
                    if (secondsRemaining <= 0) {
                        clearInterval(batchCountdownTimerId);
                        batchCountdownTimerId = null;
                    }
                }, 1000);

                // Jadwalkan tugas berikutnya
                batchTimeoutId = setTimeout(runBatchTask, intervalSeconds * 1000);

            }

            // (FUNGSI DIUBAH TOTAL)
            async function handleGenerateClick() {
                if (isGenerating) return;
                
                // --- 1. Logika Mode List (Batch) ---
                if (currentMode === 'list') {
                    if (isBatchRunning) {
                        stopBatchGeneration();
                    } else {
                        await startBatchGeneration();
                        if (commandPromptInput) { commandPromptInput.value = ''; autosizeCommandPrompt(); }
                        try { adjustCanvasLayout(); } catch (_) {}
                    }
                    return; // Selesai untuk mode list
                }

                // --- 2. Persiapan untuk Mode Single & Template ---
                const imageCount = parseInt(document.getElementById('image-count').value, 10) || 1;
                const aspectRatio = document.getElementById('select-aspect-ratio').value;
                const subjectRefs = [...subjectReferenceBase64s];
                const styleRefs = [...styleReferenceBase64s];
                
                isGenerating = true;
                generateBtn.disabled = true;
                generateBtnText.textContent = 'Menghasilkan...';
                generateIcon.classList.add('animate-spin'); 
                try { syncCommandGenerateBtn(); } catch (_) {}

                if (currentView !== 'canvas') {
                    await switchView('canvas');
                }
                try { adjustCanvasLayout(); } catch (_) {}

                try {
                    if (currentMode === 'single') {
                        // --- 3. LOGIKA MODE SINGLE ---
                        const originalPrompt = inputs.single.value.trim();
                        if (!originalPrompt) {
                            showMessage("Silakan masukkan deskripsi gambar.", 'error');
                            throw new Error("Validation failed"); // Hentikan eksekusi
                        }
                        if (commandPromptInput) { commandPromptInput.value = ''; autosizeCommandPrompt(); }
                        if (inputs.single) { inputs.single.value = ''; }
                        
                        const baseIndex = generatedImages.length;
                        await processSinglePrompt(originalPrompt, imageCount, aspectRatio, subjectRefs, styleRefs, baseIndex);

                    } else if (currentMode === 'template') {
                        // --- 4. LOGIKA MODE TEMPLATE (MULTI-PROMPT) ---
                        const subjectText = (inputs.template?.value || '').trim();
                        
                        if (selectedTemplatePrompts.length === 0) { 
                            showMessage("Silakan pilih template terlebih dahulu.", 'error');
                            throw new Error("Validation failed"); // Hentikan eksekusi
                        }
                        if (!subjectText && subjectRefs.length === 0) {
                            showMessage("Silakan masukkan subjek atau unggah referensi subjek.", 'error');
                            throw new Error("Validation failed"); // Hentikan eksekusi
                        }
                        if (commandPromptInput) { commandPromptInput.value = ''; autosizeCommandPrompt(); }
                        if (inputs.template) { inputs.template.value = ''; }

                        let globalImageIndex = 0;
                        // Loop untuk setiap template yang dipilih
                        for (const templatePrompt of selectedTemplatePrompts) {
                            const originalPrompt = templatePrompt.replace(/\[SUBJECT\]/gi, subjectText).trim();
                            const templateName = originalPrompt.substring(0, 30) + (originalPrompt.length > 30 ? "..." : "");

                            // Mode template tidak menggunakan optimizer
                            let prompts = new Array(imageCount).fill(originalPrompt);

                            const placeholderCards = prompts.map((prompt, i) => {
                                const card = createPlaceholderCard(prompt, globalImageIndex);
                                prependCardWithDate(card);
                                generatedImages.push(null);
                                globalImageIndex++;
                                return { card, prompt };
                            });

                            // Render ikon Lucide untuk kartu template yang baru ditambahkan
                            if (window.lucide && typeof lucide.createIcons === 'function') {
                                lucide.createIcons();
                            }
                            
                            // Jalankan generasi untuk batch kartu ini
                            await Promise.allSettled(placeholderCards.map(async ({ card, prompt }) => {
                                // Log penggunaan prompt (mode template)
                                logPromptToSupabase('template', prompt);
                                try {
                                    // (PERBAIKAN) Kirim model ke updateCard
                                    const { base64, model } = await generateImage(prompt, aspectRatio, subjectRefs, styleRefs);
                                    if (!base64) throw new Error("API tidak mengembalikan gambar.");
                                    await updateCard(card, prompt, base64, model);
                                } catch (error) {
                                    console.error("Gagal memproses prompt:", error);
                                    await updateCard(card, prompt, null, null);
                                }
                            }));
                        }
                        showMessage("Selesai menghasilkan semua template!", 'success');
                    }

                } catch (error) {
                    if (error.message !== "Validation failed") { // Jangan tampilkan pesan galat untuk validasi
                        console.error("Terjadi galat:", error);
                        showMessage("Terjadi galat yang tidak diketahui.", 'error');
                    }
                } finally {
                    isGenerating = false;
                    generateBtn.disabled = false;
                    // Kembalikan teks tombol berdasarkan mode
                    if (currentMode === 'list') {
                         generateBtnText.textContent = isBatchRunning ? 'Hentikan Batch' : 'Mulai Batch';
                    } else {
                         generateBtnText.textContent = 'Hasilkan Gambar';
                    }
                    generateIcon.classList.remove('animate-spin');
                    // Tampilkan tombol download jika ada gambar
                    if (generatedImages.some(img => img && img.base64)) {
                        downloadBtn.classList.remove('hidden');
                    }
                    try { syncCommandGenerateBtn(); } catch (_) {}
                    try { adjustCanvasLayout(); } catch (_) {}
                }
            }


            function createPlaceholderCard(prompt, index) {
                const card = document.createElement('div');
                card.className = 'relative group bg-neutral-900 rounded-lg shadow-md aspect-square flex items-center justify-center p-4 border border-neutral-800 overflow-hidden';
                card.dataset.index = index;
                card.dataset.prompt = prompt; 

                card.innerHTML = `
                    <img src="" alt="Generated Image" class="absolute inset-0 w-full h-full object-cover rounded-lg hidden">
                    <div class="loading-overlay absolute inset-0 flex flex-col items-center justify-center gap-3">
                        <div class="spinner"></div>
                        <p class="text-xs font-medium text-neutral-300">Menghasilkan gambar...</p>
                        <div class="loading-bar w-40 h-1"></div>
                    </div>
                    <!-- Overlay Keterangan -->
                    <div class="absolute bottom-0 left-0 right-0 p-3 bg-gradient-to-t from-black/70 to-transparent transition-opacity opacity-0 group-hover:opacity-100">
                        <p class="card-prompt text-white text-xs font-medium line-clamp-3" title="${prompt}">${prompt}</p>
                    </div>
                    <!-- Tombol Aksi -->
                    <div class="absolute top-3 right-3 flex flex-col gap-2 transition-opacity opacity-0 group-hover:opacity-100">
                        <!-- Download -->
                        <div class="relative group/btn">
                            <button class="download-single-btn p-2 rounded-full bg-green-500 hover:bg-green-600 text-white shadow-lg transition-colors disabled:bg-slate-400 active:scale-95" disabled title="Download Image">
                                <i data-lucide="download" class="w-4 h-4"></i>
                            </button>
                            <span class="absolute z-10 right-full top-1/2 -translate-y-1/2 mr-2 p-1 px-2 text-xs font-medium text-white bg-slate-800 rounded opacity-0 group-hover/btn:opacity-100 transition-opacity pointer-events-none whitespace-nowrap">Unduh</span>
                        </div>
                        <!-- Regenerate -->
                        <div class="relative group/btn">
                            <button class="regenerate-btn p-2 rounded-full bg-blue-500 hover:bg-blue-600 text-white shadow-lg transition-colors disabled:bg-slate-400 active:scale-95" disabled title="Regenerate">
                                <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                            </button>
                            <span class="absolute z-10 right-full top-1/2 -translate-y-1/2 mr-2 p-1 px-2 text-xs font-medium text-white bg-slate-800 rounded opacity-0 group-hover/btn:opacity-100 transition-opacity pointer-events-none whitespace-nowrap">Regenerate</span>
                        </div>
                        <!-- Copy Prompt -->
                        <div class="relative group/btn">
                            <button class="copy-prompt-btn p-2 rounded-full bg-white/10 hover:bg-white/20 text-neutral-200 shadow-lg transition-colors disabled:bg-slate-400 active:scale-95" disabled title="Copy Prompt">
                                <i data-lucide="copy" class="w-4 h-4"></i>
                            </button>
                            <span class="absolute z-10 right-full top-1/2 -translate-y-1/2 mr-2 p-1 px-2 text-xs font-medium text-white bg-slate-800 rounded opacity-0 group-hover/btn:opacity-100 transition-opacity pointer-events-none whitespace-nowrap">Salin Prompt</span>
                        </div>
                    </div>
                `;

                // Tambahkan event listener di sini
                card.querySelector('.download-single-btn').addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    const base64 = card.dataset.base64;
                    if (base64) {
                        downloadBase64File(base64, `generated_image_${index}.png`);
                        showMessage("Gambar diunduh.", 'success');
                    }
                });
                card.querySelector('.regenerate-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    handleRegenerate(card);
                });
                card.querySelector('.copy-prompt-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    copyToClipboard(card.dataset.prompt);
                });
                card.querySelector('img').addEventListener('click', () => openPreview(card.dataset.base64));
                return card;
            }

            function getDateKey(ts = Date.now()) {
                const d = new Date(ts);
                const y = d.getFullYear();
                const m = String(d.getMonth()+1).padStart(2,'0');
                const day = String(d.getDate()).padStart(2,'0');
                return `${y}-${m}-${day}`;
            }
            function formatDateLabel(key) {
                const [y,m,day] = key.split('-');
                const months = ['Jan','Feb','Mar','Apr','Mei','Jun','Jul','Agu','Sep','Okt','Nov','Des'];
                return `${parseInt(day,10)} ${months[parseInt(m,10)-1]} ${y}`;
            }
            function ensureDateDividerForToday() {
                const key = getDateKey();
                let divider = document.getElementById(`date-${key}`);
                if (!divider) {
                    divider = document.createElement('div');
                    divider.id = `date-${key}`;
                    divider.className = 'date-divider flex items-center gap-2 my-2';
                    divider.innerHTML = `<div class="h-px flex-1 bg-neutral-700"></div><span class="text-xs text-neutral-400 font-semibold">${formatDateLabel(key)}</span><div class="h-px flex-1 bg-neutral-700"></div>`;
                    outputGrid.prepend(divider);
                } else {
                    // Pastikan divider berada di atas
                    if (outputGrid.firstChild !== divider) outputGrid.prepend(divider);
                }
                return divider;
            }
            function prependCardWithDate(card) {
                const divider = ensureDateDividerForToday();
                if (divider.nextSibling) {
                    outputGrid.insertBefore(card, divider.nextSibling);
                } else {
                    outputGrid.appendChild(card);
                }
            }
            function updateCommandBarContrast() {
                try {
                    const hasImages = generatedImages.some(img => img && img.base64);
                    const onCanvas = currentView === 'canvas';
                    commandBar.classList.toggle('cb-on-image', onCanvas && hasImages);
                } catch (_) {}
            }
            
            function handleModeChange() {
                const selectedMode = document.querySelector('input[name="mode"]:checked').value;
                currentMode = selectedMode;
                setRefsForMode(currentMode);

                // Sembunyikan semua panel dulu
                Object.values(panels).forEach(panel => panel.classList.add('hidden'));
                
                // (DIMODIFIKASI) Logika untuk menampilkan/menyembunyikan panel dan pengaturan
                if (currentMode === 'single') {
                    if (panels.single) panels.single.classList.remove('hidden');
                    if (optimizerContainer) optimizerContainer.classList.remove('hidden');
                    if (subjectReferenceContainer) subjectReferenceContainer.classList.remove('hidden');
                    if (styleReferenceContainer) styleReferenceContainer.classList.remove('hidden');
                    if (imageCountContainer) imageCountContainer.classList.remove('hidden');
                    if (aspectRatioContainer) aspectRatioContainer.classList.remove('hidden');
                    if (panels.list) panels.list.classList.add('hidden');
                    if (panels.template) panels.template.classList.add('hidden');
                } else if (currentMode === 'template') {
                    if (panels.single) panels.single.classList.add('hidden');
                    if (panels.template) panels.template.classList.remove('hidden');
                    if (optimizerContainer) optimizerContainer.classList.add('hidden');
                    if (subjectReferenceContainer) subjectReferenceContainer.classList.remove('hidden');
                    if (styleReferenceContainer) styleReferenceContainer.classList.add('hidden');
                    if (imageCountContainer) imageCountContainer.classList.remove('hidden');
                    if (aspectRatioContainer) aspectRatioContainer.classList.remove('hidden');
                    if (panels.list) panels.list.classList.add('hidden');
                } else if (currentMode === 'list') {
                    if (panels.list) panels.list.classList.remove('hidden');
                    if (panels.single) panels.single.classList.add('hidden');
                    if (optimizerContainer) optimizerContainer.classList.add('hidden');
                    if (subjectReferenceContainer) subjectReferenceContainer.classList.add('hidden');
                    if (styleReferenceContainer) styleReferenceContainer.classList.remove('hidden');
                    if (imageCountContainer) imageCountContainer.classList.remove('hidden');
                    if (aspectRatioContainer) aspectRatioContainer.classList.remove('hidden');
                    if (panels.template) panels.template.classList.add('hidden');
                }
                
                // (BARU) Ubah teks tombol Generate untuk Mode List
                if (currentMode === 'list') {
                    generateBtnText.textContent = isBatchRunning ? 'Hentikan Batch' : 'Mulai Batch';
                } else {
                    generateBtnText.textContent = 'Hasilkan Gambar';
                }
                try { applyCommandBarByMode(); } catch (_) {}
                try { updateModeMenuActive(); } catch (_) {}
                updateModeTabsActive();
            }
            
            // (DIMODIFIKASI) handleTemplateClick untuk multi-select (toggle)
            function handleTemplateClick(e) {
                const btn = e.currentTarget;
                const prompt = btn.dataset.prompt;
                const index = selectedTemplatePrompts.indexOf(prompt);

                if (index > -1) { // Jika sudah ada, hapus (deselect)
                    selectedTemplatePrompts.splice(index, 1);
                    btn.classList.remove('ring-blue-500');
                    btn.classList.add('ring-transparent');
                    btn.classList.remove('border-blue-400');
                    btn.classList.add('border-slate-200');
                } else { // Jika belum ada, tambahkan (select)
                    selectedTemplatePrompts.push(prompt);
                    btn.classList.add('ring-blue-500');
                    btn.classList.remove('ring-transparent');
                    btn.classList.remove('border-slate-200');
                    btn.classList.add('border-blue-400');
                }
                
                showMessage(`Anda telah memilih ${selectedTemplatePrompts.length} template.`, 'info');
                safeFocus(inputs.template || inputs.single);
                renderSelectedTemplatesList();
                updateSelectedTemplateCount();
                try { renderTemplateChips(); } catch(_) {}
            }

            // === EVENT LISTENERS ===
            
            // Inisialisasi Mode
            modeRadios.forEach(radio => radio.addEventListener('change', handleModeChange));
            handleModeChange();
            updateModeTabsActive();

            // (BARU) Accordion Pengaturan System
            if (systemAccordionBtn) systemAccordionBtn.addEventListener('click', () => {
                const isHidden = systemAccordionContent.classList.contains('hidden');
                if (isHidden) {
                    systemAccordionContent.classList.remove('hidden');
                    systemAccordionIcon.style.transform = 'rotate(180deg)';
                } else {
                    systemAccordionContent.classList.add('hidden');
                    systemAccordionIcon.style.transform = 'rotate(0deg)';
                }
            });

            // (BARU) Tombol Deselect semua pilihan
            if (templateDeselectAllBtn) {
                templateDeselectAllBtn.addEventListener('click', () => {
                    if (selectedTemplatePrompts.length === 0) return;
                    selectedTemplatePrompts = [];
                    document.querySelectorAll('.template-btn').forEach(btn => {
                        btn.classList.remove('ring-blue-500');
                        btn.classList.add('ring-transparent');
                        btn.classList.remove('border-blue-400');
                        btn.classList.add('border-slate-200');
                    });
                    renderSelectedTemplatesList();
                    updateSelectedTemplateCount();
                    showMessage('Semua pilihan dihapus.', 'info');
                });
            }

            // (BARU) Pencarian Template Client-side
            if (templateSearchInput) {
                templateSearchInput.addEventListener('input', () => {
                    const q = templateSearchInput.value || '';
                    const cat = templateCategoryFilter ? templateCategoryFilter.value : '';
                    renderTemplateButtons(fetchedTemplates, q, cat);
                });
            }
            if (templateSearchClearBtn) {
                templateSearchClearBtn.addEventListener('click', () => {
                    templateSearchInput.value = '';
                    const cat = templateCategoryFilter ? templateCategoryFilter.value : '';
                    renderTemplateButtons(fetchedTemplates, '', cat);
                    safeFocus(templateSearchInput);
                });
            }

            if (templateCategoryFilter) {
                templateCategoryFilter.addEventListener('change', () => {
                    const q = templateSearchInput ? (templateSearchInput.value || '') : '';
                    renderTemplateButtons(fetchedTemplates, q, templateCategoryFilter.value);
                });
            }

            // (BARU) Tipe Interval (Statis/Random)
            if (listIntervalType) listIntervalType.addEventListener('change', (e) => {
                if (e.target.value === 'random') {
                    listIntervalStaticContainer.classList.add('hidden');
                    listIntervalRandomContainer.classList.remove('hidden');
                } else {
                    listIntervalStaticContainer.classList.remove('hidden');
                    listIntervalRandomContainer.classList.add('hidden');
                }
            });
            
            // (PERBAIKAN) Event Listener untuk Cropper
            if (cropCanvas) {
                cropCanvas.addEventListener('mousedown', onCropMouseDown);
                cropCanvas.addEventListener('pointerdown', onCropMouseDown, { passive: false });
                cropCanvas.addEventListener('touchstart', onCropMouseDown, { passive: false });
            }
            if (cropApplyBtn) {
                cropApplyBtn.addEventListener('click', applyCrop);
            }
            if (cropCancelBtn) {
                cropCancelBtn.addEventListener('click', cancelCrop);
            }
            if (cropAspect) {
                cropAspect.addEventListener('change', (e) => setCropperAspectRatio(e.target.value));
            }
            if (cropAspectButtons && cropAspectButtons.length > 0) {
                cropAspectButtons.forEach(btn => {
                    btn.addEventListener('click', () => {
                        const val = btn.dataset.aspect;
                        if (cropAspect) cropAspect.value = val;
                        setCropperAspectRatio(val);
                        setActiveCropAspectButton(val);
                    });
                });
            }
            
            if (topNavItems && topNavItems.length > 0) {
                topNavItems.forEach(btn => {
                    btn.addEventListener('click', () => {
                        const target = btn.dataset.menu;
                        if (target === 'canvas') {
                            switchMenu('canvas');
                        } else if (target === 'ugc') {
                            switchMenu('ugc');
                        } else if (target === 'catalog') {
                            switchMenu('catalog');
                        }
                        renderTopNavActive();
                    });
                });
            }
            bindInfoTooltip('subject-reference-container');
            bindInfoTooltip('style-reference-container');

            
            if (cropUndoBtn) {
                cropUndoBtn.addEventListener('click', undoCrop);
            }
            if (cropRedoBtn) {
                cropRedoBtn.addEventListener('click', redoCrop);
            }

            // Referensi Subjek & Gaya
            function initUnifiedUploader(inputEl, arrays, renderFn) {
                if (!inputEl) return;
                inputEl.addEventListener('change', (e) => handleUploadWithCropTarget(e, arrays, renderFn));
            }

            function handleUploadWithCropTarget(e, arrays, renderFn) {
                try {
                    const files = e.target.files;
                    if (!files || files.length === 0) return;
                    cropperState.filesToCrop = Array.from(files);
                    cropperState.currentFileIndex = 0;
                    cropperState.editIndex = -1;
                    if (arrays && arrays.base64s) {
                        cropperState.target = { base64s: arrays.base64s, originals: arrays.originals, render: renderFn };
                    } else {
                        const base64s = modeSpecificRefs[currentMode]?.subject || modeSpecificRefs.single.subject;
                        const originals = modeSubjectOriginals[currentMode] || modeSubjectOriginals.single;
                        cropperState.target = { base64s, originals, render: renderFn };
                    }
                    openCropperForFile(cropperState.filesToCrop[0]);
                } catch (err) {
                    console.error('Upload referensi gagal:', err);
                    showMessage('Gagal memproses upload referensi.', 'error');
                } finally {
                    e.target.value = '';
                }
            }

            initUnifiedUploader(uploadSubject, null, updateSubjectPreview);
            if (clearSubjectBtn) clearSubjectBtn.addEventListener('click', clearSubjectReferences);
            if (uploadStyle) uploadStyle.addEventListener('change', (e) => handleImageUpload(e, styleReferenceBase64s, stylePreviewContainer, clearStyleBtn));
            clearStyleBtn.addEventListener('click', () => clearImageReferences(styleReferenceBase64s, uploadStyle, stylePreviewContainer, clearStyleBtn));
            
            
            // Tombol Utama
            generateBtn.addEventListener('click', handleGenerateClick);
            downloadBtn.addEventListener('click', handleDownloadZip);
            if (clearHistoryBtn) {
                clearHistoryBtn.addEventListener('click', () => clearHistory());
            }

            // Navigasi Tampilan (Canvas/History)
            if (canvasViewTitle) canvasViewTitle.addEventListener('click', () => switchView('canvas'));
            if (historyViewTitle) historyViewTitle.addEventListener('click', () => switchView('history'));
            
            // Modal Pratinjau
            closeModalBtn.addEventListener('click', closePreview);
            previewModal.addEventListener('click', (e) => { if (e.target === previewModal) closePreview(); });
            downloadPreviewBtn.addEventListener('click', (e) => {
                e.preventDefault();
                const imageUrl = previewModal.dataset.currentImageUrl;
                if (imageUrl) {
                    downloadBase64File(imageUrl, `preview_image_${new Date().getTime()}.png`);
                    showMessage("Gambar diunduh.", 'success');
                }
            });
            if (editPreviewBtn) {
                editPreviewBtn.addEventListener('click', () => {
                    if (!editPanel) return;
                    editPanel.classList.toggle('hidden');
                    safeFocus(editPromptInput);
                    positionPreviewCounter();
                });
            }
            if (cancelEditBtn) {
                cancelEditBtn.addEventListener('click', () => {
                    editPanel.classList.add('hidden');
                    positionPreviewCounter();
                });
            }
            async function applyEditFromPreview() {
                const imageUrl = previewModal.dataset.currentImageUrl;
                const prompt = (editPromptInput?.value || '').trim();
                if (!imageUrl || !prompt) {
                    showMessage("Masukkan instruksi edit.", 'info');
                    return;
                }
                const base64Data = imageUrl.split(',')[1] || '';
                const aspectRatio = document.getElementById('select-aspect-ratio')?.value || '1:1';
                try {
                    editLoading.classList.remove('hidden');
                    const { base64, model } = await generateImage(prompt, aspectRatio, [base64Data], styleReferenceBase64s);
                    if (!base64) throw new Error('Edit gagal');
                    modalImage.src = base64;
                    previewModal.dataset.currentImageUrl = base64;
                    editPanel.classList.add('hidden');
                    editLoading.classList.add('hidden');
                    const historyItem = {
                        id: `edit_${new Date().getTime()}`,
                        prompt: prompt,
                        base64: base64,
                        timestamp: new Date().getTime(),
                        model: model
                    };
                    await saveImageToHistory(historyItem);
                    showMessage("Gambar berhasil diedit dan disimpan ke riwayat.", 'success');
                } catch (err) {
                    console.error('Gagal edit gambar:', err);
                    editLoading.classList.add('hidden');
                    showMessage("Gagal mengedit gambar.", 'error');
                }
            }
            if (applyEditBtn) {
                applyEditBtn.addEventListener('click', applyEditFromPreview);
            }

            // (DIMODIFIKASI) Logika Mode Template & List
            syncTemplatesBtn.addEventListener('click', fetchAndRenderTemplates);

            // Modal Template
            if (openTemplateModalBtn) openTemplateModalBtn.addEventListener('click', openTemplateModal);
            if (closeTemplateModalBtn) closeTemplateModalBtn.addEventListener('click', closeTemplateModal);
            if (closeTemplateModalBottom) closeTemplateModalBottom.addEventListener('click', closeTemplateModal);
            if (templateModal) {
                templateModal.addEventListener('click', (e) => { if (e.target === templateModal) closeTemplateModal(); });
            }
            if (templateViewToggle) {
                templateViewToggle.addEventListener('click', () => {
                    templateViewMode = templateViewMode === 'grid' ? 'list' : 'grid';
                    // (PERBAIKAN) Panggil render ulang DAN apply
                    const q = templateSearchInput ? (templateSearchInput.value || '') : '';
                    const cat = templateCategoryFilter ? templateCategoryFilter.value : '';
                    renderTemplateButtons(fetchedTemplates, q, cat); // Re-render buttons
                    applyTemplateViewMode(); // Atur container & ikon
                });
            }
            
            // (BARU) Logika Mode List
            const savedListUrl = localStorage.getItem(LIST_URL_KEY);
            if (savedListUrl) {
                listSheetUrlInput.value = savedListUrl;
            }
            saveListUrlBtn.addEventListener('click', () => {
                const url = listSheetUrlInput.value.trim();
                if (url) {
                    localStorage.setItem(LIST_URL_KEY, url);
                    showMessage("URL Google Sheet disimpan!", 'success');
                    fetchListPrompts(); // Otomatis sinkronisasi setelah menyimpan
                }
            });
            syncListBtn.addEventListener('click', fetchListPrompts);
            
            // === INISIALISASI ===
            getDB().then(() => {
                console.log("Koneksi IndexedDB berhasil.");
                if (currentView === 'history') {
                    switchView('history'); 
                }
                // Inisialisasi scroll independen untuk kedua area modal template
                setupIndependentScroll(templateLeftScroll);
                setupIndependentScroll(templateRightScroll);
                // Inisialisasi scroll independen untuk area crop modal
                setupIndependentScroll(cropLeftScroll);
                setupIndependentScroll(cropRightScroll);
                
            }).catch(err => {
                console.error("Inisialisasi IndexedDB gagal:", err);
                showMessage("Gagal memuat database riwayat.", 'error');
            });
            
            fetchAndRenderTemplates(); // Muat template saat halaman dibuka
            fetchListPrompts(); // Muat daftar list saat halaman dibuka (jika URL tersimpan)
            renderSelectedTemplatesList();
            updateSelectedTemplateCount();

            function switchMenu(menu) {
                currentMenu = menu;
                if (sidebarTitle) {
                    if (menu === 'canvas') sidebarTitle.textContent = 'Canvas AI';
                    else if (menu === 'ugc') sidebarTitle.textContent = 'UGC Creation';
                    else sidebarTitle.textContent = 'Etalase Produk';
                }
                if (sidebarCanvas) sidebarCanvas.classList.toggle('hidden', menu !== 'canvas');
                const sidebarCanvasActions = document.getElementById('sidebar-canvas-actions');
                if (sidebarCanvasActions) sidebarCanvasActions.classList.toggle('hidden', menu !== 'canvas');
                renderTopNavActive();
            }

            const commandBar = document.getElementById('command-bar');
            const modeSelectorBtn = document.getElementById('mode-selector');
            const modeMenu = document.getElementById('mode-menu');
            const commandPromptInput = document.getElementById('command-prompt');
            const addRefBtn = document.getElementById('add-ref-btn');
            const addStyleBtn = document.getElementById('add-style-btn');
            const uploadSubjectPopover = document.getElementById('upload-subject-popover');
            const uploadSubjectChooseBtn = document.getElementById('upload-subject-choose-btn');
            const commandSubjectPopoverPreview = document.getElementById('command-subject-popover-preview');
            const openSettingsBtn = document.getElementById('open-settings-btn');
            const settingsPopover = document.getElementById('settings-popover');
            const settingsSummary = document.getElementById('settings-summary');
            const commandGenerateBtn = document.getElementById('command-generate-btn');
            const aspectPresets = document.getElementById('aspect-presets');
            let preferredModel = 'auto';

            function autosizeCommandPrompt() {
                if (!commandPromptInput) return;
                commandPromptInput.style.height = 'auto';
                const next = Math.min(160, commandPromptInput.scrollHeight);
                commandPromptInput.style.height = next + 'px';
            }

            function applyCommandBarByMode() {
                if (!commandPromptInput) return;
                const labelEl = modeSelectorBtn ? modeSelectorBtn.querySelector('span') : null;
                if (currentMode === 'single') {
                    commandPromptInput.placeholder = 'Buat gambar dari teks dan referensi';
                    document.getElementById('cb-textarea-body')?.classList.remove('hidden');
                    document.getElementById('cb-template-body')?.classList.add('hidden');
                    document.getElementById('cb-running-body')?.classList.add('hidden');
                    if (addRefBtn) addRefBtn.classList.remove('hidden');
                    if (addStyleBtn) addStyleBtn.classList.remove('hidden');
                    document.getElementById('style-thumbs')?.classList.remove('hidden');
                    document.getElementById('ref-thumbs')?.classList.remove('hidden');
                    if (labelEl) labelEl.textContent = 'Single';
                    document.getElementById('settings-system')?.classList.add('hidden');
                } else if (currentMode === 'template') {
                    document.getElementById('cb-textarea-body')?.classList.add('hidden');
                    document.getElementById('cb-template-body')?.classList.remove('hidden');
                    document.getElementById('cb-running-body')?.classList.add('hidden');
                    if (addRefBtn) addRefBtn.classList.remove('hidden');
                    if (addStyleBtn) addStyleBtn.classList.add('hidden');
                    document.getElementById('style-thumbs')?.classList.add('hidden');
                    document.getElementById('ref-thumbs')?.classList.remove('hidden');
                    if (labelEl) labelEl.textContent = 'Template';
                    document.getElementById('settings-system')?.classList.add('hidden');
                } else if (currentMode === 'list') {
                    commandPromptInput.placeholder = 'Masukkan URL Google Sheet atau prompt daftar';
                    document.getElementById('cb-textarea-body')?.classList.toggle('hidden', isBatchRunning);
                    document.getElementById('cb-running-body')?.classList.toggle('hidden', !isBatchRunning);
                    document.getElementById('cb-template-body')?.classList.add('hidden');
                    if (addRefBtn) addRefBtn.classList.add('hidden');
                    if (addStyleBtn) addStyleBtn.classList.remove('hidden');
                    document.getElementById('style-thumbs')?.classList.remove('hidden');
                    document.getElementById('ref-thumbs')?.classList.add('hidden');
                    if (labelEl) labelEl.textContent = 'List';
                    document.getElementById('settings-system')?.classList.remove('hidden');
                }
                autosizeCommandPrompt();
                try { syncCommandGenerateBtn(); } catch (_) {}
                try { adjustCanvasLayout(); } catch (_) {}
            }

            function updateModeMenuActive() {
                if (!modeMenu) return;
                const buttons = Array.from(modeMenu.querySelectorAll('button[data-mode]'));
                buttons.forEach(btn => {
                    btn.classList.remove('bg-white/10','border-white/20','text-white');
                    btn.classList.remove('ring-1','ring-white/20');
                    const m = btn.getAttribute('data-mode');
                    if (m === currentMode) {
                        btn.classList.add('bg-white/10','border-white/20','text-white');
                        btn.classList.add('ring-1','ring-white/20');
                    }
                });
            }

            function renderSettingsSummary() {
                try {
                    const ar = document.getElementById('select-aspect-ratio')?.value || '';
                    const cnt = parseInt(document.getElementById('image-count')?.value || '1', 10);
                    const hasRefs = (subjectReferenceBase64s?.length || 0) > 0 || (styleReferenceBase64s?.length || 0) > 0;
                    let modelLabel = 'Imagen 4';
                    if (preferredModel === 'gemini') modelLabel = 'Gemini';
                    else if (preferredModel === 'imagen') modelLabel = 'Imagen 4';
                    else modelLabel = hasRefs ? 'Gemini' : 'Imagen 4';
                    if (!settingsSummary) return;
                    settingsSummary.textContent = `${modelLabel}  ${ar}  x${cnt}`;
                    settingsSummary.classList.remove('hidden');
                } catch (_) {}
            }

            function updateCommandBarListCountInfo() {
                try {
                    const stats = document.getElementById('cb-stats');
                    const info = document.getElementById('command-list-count-info');
                    if (!info || !stats) return;
                    if (currentMode === 'list') {
                        const n = fetchedListPrompts?.length || 0;
                        info.textContent = `${n} prompt dimuat`;
                        stats.classList.remove('hidden');
                        info.classList.remove('hidden');
                    } else {
                        stats.classList.add('hidden');
                        info.classList.add('hidden');
                        document.getElementById('command-list-countdown-info')?.classList.add('hidden');
                        document.getElementById('command-list-elapsed-info')?.classList.add('hidden');
                    }
                } catch (_) {}
            }

            function updateCommandBarTimers(countdownText, elapsedText) {
                try {
                    const cdEl = document.getElementById('command-list-countdown-info');
                    const elEl = document.getElementById('command-list-elapsed-info');
                    if (cdEl) {
                        if (typeof countdownText === 'string' && countdownText.length) {
                            cdEl.textContent = countdownText;
                            cdEl.classList.remove('hidden');
                        } else {
                            cdEl.classList.add('hidden');
                        }
                    }
                    if (elEl) {
                        if (typeof elapsedText === 'string' && elapsedText.length) {
                            elEl.textContent = elapsedText;
                            elEl.classList.remove('hidden');
                        } else {
                            elEl.classList.add('hidden');
                        }
                    }
                } catch (_) {}
            }

            function syncCommandGenerateBtn() {
                try {
                    const btn = document.getElementById('command-generate-btn');
                    if (!btn) return;
                    const running = currentMode === 'list' ? isBatchRunning : isGenerating;
                    if (running) {
                        btn.classList.remove('bg-blue-600','hover:bg-blue-700');
                        btn.classList.add('bg-red-600','hover:bg-red-700');
                        btn.title = 'Stop';
                        btn.innerHTML = '<i data-lucide="square" class="w-5 h-5"></i>';
                    } else {
                        btn.classList.add('bg-blue-600','hover:bg-blue-700');
                        btn.classList.remove('bg-red-600','hover:bg-red-700');
                        btn.title = 'Mulai';
                        btn.innerHTML = '<i data-lucide="arrow-right" class="w-5 h-5"></i>';
                    }
                    if (window.lucide && typeof lucide.createIcons === 'function') {
                        lucide.createIcons();
                    }
                } catch (_) {}
            }

            function syncPromptFromCommandBar() {
                try {
                    const v = (commandPromptInput?.value || '').trim();
                    if (currentMode === 'template' && inputs.template) inputs.template.value = v; else if (inputs.single) inputs.single.value = v;
                } catch (_) {}
            }

            function renderTemplateChips() {
                const chipsEl = document.getElementById('template-chips');
                if (!chipsEl) return;
                chipsEl.innerHTML = '';
                try {
                    const selected = (typeof fetchedTemplates !== 'undefined')
                        ? fetchedTemplates.filter(t => selectedTemplatePrompts.includes(t.prompt))
                        : selectedTemplatePrompts.map(p => ({ name: p, prompt: p }));
                    selected.forEach(t => {
                        const chip = document.createElement('span');
                        chip.className = 'flex items-center gap-2 px-3 py-1.5 text-xs rounded-md bg-white/10 border border-neutral-700 text-neutral-200';
                        const label = document.createElement('span');
                        label.textContent = t.name || 'Template';
                        const del = document.createElement('button');
                        del.className = 'p-1 rounded hover:bg-white/10';
                        del.innerHTML = '<i data-lucide="x" class="w-3 h-3"></i>';
                        del.addEventListener('click', () => {
                            const idx = selectedTemplatePrompts.indexOf(t.prompt);
                            if (idx > -1) {
                                selectedTemplatePrompts.splice(idx, 1);
                                renderTemplateChips();
                                try { renderSelectedTemplatesList(); updateSelectedTemplateCount(); } catch(_) {}
                            }
                        });
                        chip.appendChild(label);
                        chip.appendChild(del);
                        chipsEl.appendChild(chip);
                    });
                } catch (_) {}
            }

            if (modeSelectorBtn && modeMenu) {
                modeSelectorBtn.addEventListener('click', () => {
                    modeMenu.classList.toggle('hidden');
                    if (!modeMenu.classList.contains('hidden')) updateModeMenuActive();
                });
                Array.from(modeMenu.querySelectorAll('button[data-mode]')).forEach(btn => {
                    btn.addEventListener('click', () => {
                        const m = btn.getAttribute('data-mode');
                        if (m === 'video-text' || m === 'video-frame' || m === 'video-mix') {
                            showMessage('Mode video belum tersedia.', 'info');
                            modeMenu.classList.add('hidden');
                            return;
                        }
                        const radio = document.querySelector(`input[name="mode"][value="${m}"]`);
                        if (radio) { radio.checked = true; handleModeChange(); }
                        setRefsForMode(m);
                        applyCommandBarByMode();
                        renderTemplateChips();
                        updateCommandBarListCountInfo();
                        modeMenu.classList.add('hidden');
                    });
                });

                const headerToggle = document.getElementById('header-view-toggle');
                if (headerToggle) {
                    Array.from(headerToggle.querySelectorAll('button[data-view]')).forEach(btn => {
                        btn.addEventListener('click', () => {
                            const v = btn.getAttribute('data-view');
                            switchMenu(v);
                            renderHeaderToggleActive();
                        });
                    });
                    renderHeaderToggleActive();
                }
                document.addEventListener('click', (e) => {
                    if (!modeMenu.contains(e.target) && !modeSelectorBtn.contains(e.target)) modeMenu.classList.add('hidden');
                });
            }
            if (commandPromptInput) {
                commandPromptInput.addEventListener('input', () => { syncPromptFromCommandBar(); autosizeCommandPrompt(); });
                autosizeCommandPrompt();
                setRefsForMode(currentMode);
                syncCommandGenerateBtn();
            }
            const chooseTemplateBtn = document.getElementById('choose-template-btn');
            if (chooseTemplateBtn && typeof templateModal !== 'undefined' && templateModal) {
                chooseTemplateBtn.addEventListener('click', () => { templateModal.classList.remove('hidden'); });
            }
            if (addRefBtn && uploadSubjectPopover) {
                addRefBtn.addEventListener('click', () => {
                    uploadSubjectPopover.classList.toggle('hidden');
                });
            }
            if (addStyleBtn && uploadStyle) {
                addStyleBtn.addEventListener('click', () => {
                    try { uploadStyle.click(); } catch (_) {}
                });
            }
            if (uploadSubjectChooseBtn && uploadSubject) {
                uploadSubjectChooseBtn.addEventListener('click', () => { try { uploadSubject.click(); } catch(_){} });
            }
            document.addEventListener('click', (e) => {
                const els = [uploadSubjectPopover, addRefBtn];
                const clickedInside = els.some(el => el && el.contains(e.target));
                if (!clickedInside) {
                    uploadSubjectPopover?.classList.add('hidden');
                }
            });
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    uploadSubjectPopover?.classList.add('hidden');
                }
            });
            if (openSettingsBtn && settingsPopover) {
                openSettingsBtn.addEventListener('click', () => {
                    settingsPopover.classList.toggle('hidden');
                    renderSettingsSummary();
                    try {
                        const sysBtn = document.getElementById('settings-system-accordion-btn');
                        const sysContent = document.getElementById('settings-system-content');
                        const sysIcon = document.getElementById('settings-system-accordion-icon');
                        const sysBox = document.getElementById('settings-system');
                        if (sysBox) sysBox.classList.toggle('hidden', currentMode !== 'list');
                        if (sysBtn && sysContent && sysIcon) {
                            sysBtn.onclick = () => {
                                const open = sysContent.classList.contains('hidden');
                                sysContent.classList.toggle('hidden', !open);
                                sysIcon.style.transform = open ? 'rotate(180deg)' : 'rotate(0deg)';
                            };
                        }

                        if (currentMode === 'list') {
                            const tSel = document.getElementById('settings-list-interval-type');
                            const sBox = document.getElementById('settings-list-interval-time');
                            const rMin = document.getElementById('settings-list-interval-min');
                            const rMax = document.getElementById('settings-list-interval-max');
                            const autoDl = document.getElementById('settings-list-auto-download');
                            const rep = document.getElementById('settings-list-repeat');
                            const repCnt = document.getElementById('settings-list-repeat-count');
                            const aSync = document.getElementById('settings-list-auto-sync');
                            const staticBox = document.getElementById('settings-interval-static');
                            const randomBox = document.getElementById('settings-interval-random');

                            if (tSel) {
                                tSel.value = listIntervalType?.value || 'static';
                                sBox.value = listIntervalTime?.value || '5';
                                rMin.value = listIntervalMin?.value || '5';
                                rMax.value = listIntervalMax?.value || '30';
                                autoDl.checked = !!(listAutoDownload && listAutoDownload.checked);
                                rep.checked = !!(listRepeat && listRepeat.checked);
                                repCnt.value = listRepeatCountInput?.value || '0';
                                aSync.checked = !!(listAutoSync && listAutoSync.checked);

                                const setMode = () => {
                                    const v = tSel.value;
                                    staticBox.classList.toggle('hidden', v !== 'static');
                                    randomBox.classList.toggle('hidden', v !== 'random');
                                };
                                setMode();
                                tSel.onchange = () => { listIntervalType.value = tSel.value; setMode(); };
                                sBox.oninput = () => { if (listIntervalTime) listIntervalTime.value = sBox.value; };
                                rMin.oninput = () => { if (listIntervalMin) listIntervalMin.value = rMin.value; };
                                rMax.oninput = () => { if (listIntervalMax) listIntervalMax.value = rMax.value; };
                                autoDl.onchange = () => { if (listAutoDownload) listAutoDownload.checked = autoDl.checked; };
                                rep.onchange = () => { if (listRepeat) listRepeat.checked = rep.checked; };
                                repCnt.oninput = () => { if (listRepeatCountInput) listRepeatCountInput.value = repCnt.value; };
                                aSync.onchange = () => { if (listAutoSync) listAutoSync.checked = aSync.checked; };
                            }
                        }
                    } catch (_) {}
                });
                document.getElementById('select-aspect-ratio')?.addEventListener('change', renderSettingsSummary);
                document.getElementById('image-count')?.addEventListener('input', renderSettingsSummary);
                document.getElementById('select-model')?.addEventListener('change', (e) => { preferredModel = e.target.value || 'auto'; });
                if (aspectPresets) {
                    Array.from(aspectPresets.querySelectorAll('button[data-aspect]')).forEach(btn => {
                        btn.addEventListener('click', () => {
                            const val = btn.getAttribute('data-aspect');
                            const sel = document.getElementById('select-aspect-ratio');
                            if (sel) sel.value = val;
                            renderSettingsSummary();
                        });
                    });
                }
                document.addEventListener('click', (e) => {
                    try {
                        const clickedInside = settingsPopover.contains(e.target) || openSettingsBtn.contains(e.target);
                        if (!clickedInside) settingsPopover.classList.add('hidden');
                    } catch (_) {}
                });
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') settingsPopover.classList.add('hidden');
                });
            }
            if (commandGenerateBtn && generateBtn) {
                commandGenerateBtn.addEventListener('click', () => {
                    try { generateBtn.click(); } catch (_) {}
                });
            }
            const gridToggleBtn = document.getElementById('grid-toggle-btn');
            const listToggleBtn = document.getElementById('list-toggle-btn');
            function setOutputLayout(type) {
                if (!outputGrid) return;
                outputGrid.classList.remove('grid-cols-1','sm:grid-cols-2','xl:grid-cols-3');
                if (type === 'list') {
                    outputGrid.classList.add('grid-cols-1');
                } else {
                    outputGrid.classList.add('grid-cols-1','sm:grid-cols-2','xl:grid-cols-3');
                }
            }
            if (gridToggleBtn) gridToggleBtn.addEventListener('click', () => setOutputLayout('grid'));
            if (listToggleBtn) listToggleBtn.addEventListener('click', () => setOutputLayout('list'));
            const outputSearchInput = document.getElementById('output-search');
            if (outputSearchInput) {
                outputSearchInput.addEventListener('input', () => {
                    const q = (outputSearchInput.value || '').toLowerCase();
                    Array.from(outputGrid.querySelectorAll('[data-prompt]')).forEach(card => {
                        const p = (card.dataset.prompt || '').toLowerCase();
                        card.classList.toggle('hidden', q && !p.includes(q));
                    });
                });
            }
            renderSettingsSummary();
            applyCommandBarByMode();
            renderTemplateChips();
            updateCommandBarListCountInfo();

            function adjustCanvasLayout() {
                try {
                    const topNavEl = document.getElementById('top-nav');
                    const headerEl = document.querySelector('main > header');
                    const mainEl = document.querySelector('main');
                    const cb = document.getElementById('command-bar');
                    if (headerEl && topNavEl) {
                        headerEl.style.top = `${topNavEl.offsetHeight}px`;
                        document.documentElement.style.setProperty('--header-height', `${topNavEl.offsetHeight + headerEl.offsetHeight}px`);
                    }
                    if (mainEl && cb) {
                        mainEl.style.paddingBottom = `${cb.offsetHeight + 48}px`;
                    }
                } catch (_) {}
            }
            adjustCanvasLayout();
            window.addEventListener('resize', adjustCanvasLayout);
            window.addEventListener('orientationchange', adjustCanvasLayout);
        });
            
    </script>
</body>
</html>
